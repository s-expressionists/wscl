<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1 plus MathML 2.0//EN"
  "http://www.w3.org/Math/DTD/mathml2/xhtml-math11-f.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta charset="utf-8"/><link rel="stylesheet" type="text/css" href="../style.css"/><script src="../permalink.js"/><script src="../navigation.js"/><title>Well-specified Common Lisp — WITH-PACKAGE-ITERATOR-END</title></head><body><main><nav class="sidebar"><span class="name">Entry Points</span><br/><ol><li><a href="../chap-0.xhtml#section-Figures">Table of Contents</a></li><li><a href="../symbol-index.xhtml#section-SymbolIndex">Symbol Index</a></li><li><a href="../figure-index.xhtml#section-FigureIndex">Figure Index</a></li><li><a href="../issue-index.xhtml#section-IssueIndices">Issue Index</a></li><li><a href="../note-indices.xhtml#section-ReviewerNoteIndex">Note Indices</a></li><li><a href="../chapter-26.xhtml#section-Glossary">Glossary</a></li></ol><hr/><span class="name">WITH-PACKAGE-ITERATOR-END</span><br/><ol class="local-toc"><li><a href="#section-Edit history">Edit history</a><ol> </ol></li><li><a href="#section-Problem description">Problem description</a><ol> </ol></li><li><a href="#issue-with-package-iterator-end:once-only">Proposal ONCE-ONLY</a><ol> </ol></li><li><a href="#section-Test Cases">Test Cases</a><ol> </ol></li><li><a href="#section-Rationale">Rationale</a><ol> </ol></li><li><a href="#section-Current practice">Current practice</a><ol> </ol></li><li><a href="#section-Cost to Implementors">Cost to Implementors</a><ol> </ol></li><li><a href="#section-Cost to Users">Cost to Users</a><ol> </ol></li><li><a href="#section-Cost of non-adoption">Cost of non-adoption</a><ol> </ol></li><li><a href="#section-Performance impact">Performance impact</a><ol> </ol></li><li><a href="#section-Benefits">Benefits</a><ol> </ol></li><li><a href="#section-Esthetics">Esthetics</a><ol> </ol></li><li><a href="#section-Discussion">Discussion</a><ol> </ol></li></ol></nav><div class="content"><h1>X3J13 Issue WITH-PACKAGE-ITERATOR-END [NIL] [CLARIFICATION]</h1><h2>Related issues</h2><ul><li><a class="issue-reference" href="../issues/hash-table-package-generators.xhtml#issue-hash-table-package-generators">HASH-TABLE-PACKAGE-GENERATORS</a></li></ul><section id="section-Edit history" class="section"><h2 class="section-title">Edit history</h2>2-May-90, Version 1 by Moon 8-Jun-90, Version 2 by Moon (as amended at X3J13 meeting) </section><section id="section-Problem description" class="section"><h2 class="section-title">Problem description</h2>  The writeup in <a class="issue-reference" href="../issues/hash-table-package-generators.xhtml#issue-hash-table-package-generators:add-with-wrapper">HASH-TABLE-PACKAGE-GENERATORS:ADD-WITH-WRAPPER</a> is   unfortunately ambiguous about whether it's valid to call the   next-function again after it has returned <a class="section-reference" href="../chapter-1.xhtml#section-NIL">NIL</a> once.  The descriptions of   <a class="macro-reference" href="../chapter-18.xhtml#macro-with-hash-table-iterator">WITH-HASH-TABLE-ITERATOR</a> and <a class="macro-reference" href="../chapter-11.xhtml#macro-with-package-iterator">WITH-PACKAGE-ITERATOR</a> say: <br/>    After all entries <code><span class="syntax-root"><span class="syntax-cons">(<span class="syntax-interned-symbol">symbols</span>)</span>
</span></code> have been returned [by successive     invocations of <code><span class="syntax-root"><span class="syntax-cons">(<span class="syntax-interned-symbol">&lt;next-fn&gt;</span>)</span>
</span></code>], then only one value is returned, namely     <a class="section-reference" href="../chapter-1.xhtml#section-NIL">NIL</a>. <br/>  The problem is that if calling the next-function again after it returns   <a class="section-reference" href="../chapter-1.xhtml#section-NIL">NIL</a> is valid, it turns out that the implementation of the generator has   to be less efficient.  But these language features exist primarily for   <a class="macro-reference" href="../chapter-6.xhtml#macro-loop">LOOP</a> and other portable iteration facilities, and <a class="macro-reference" href="../chapter-6.xhtml#macro-loop">LOOP</a> <pre><code><span class="syntax-root"><span class="syntax-cons">(<a class="macro-reference" href="../chapter-5.xhtml#macro-and">and</a> <span class="syntax-interned-symbol">probably</span> <a class="special-operator-reference" href="../chapter-3.xhtml#special-operator-the">the</a>
  <span class="syntax-interned-symbol">other</span> <span class="syntax-interned-symbol">facilities</span> <span class="syntax-interned-symbol">too</span>)</span>
</span></code></pre> will never call the next-function after it returns   <a class="section-reference" href="../chapter-1.xhtml#section-NIL">NIL</a>, because that terminates the iteration. <br/>  This is Symbolics issue #24. <br/></section><section class="status-unknown proposal" id="issue-with-package-iterator-end:once-only"><h2 class="section-title">Proposal ONCE-ONLY</h2>  Clarify that the consequences are undefined if the next-function is called   after it has returned <a class="section-reference" href="../chapter-1.xhtml#section-NIL">NIL</a> as its first value. <br/></section><section id="section-Test Cases" class="section"><h2 class="section-title">Test Cases</h2><pre>  Macroexpand the following:<br/><br/>    <code><span class="syntax-root"><span class="syntax-cons">(<a class="macro-reference" href="../chapter-6.xhtml#macro-loop">loop</a> <span class="syntax-interned-symbol">for</span> <span class="syntax-interned-symbol">k</span> <span class="syntax-interned-symbol">being</span> <span class="syntax-interned-symbol">each</span> <span class="syntax-interned-symbol">hash-key</span> <span class="syntax-interned-symbol">of</span> <span class="syntax-interned-symbol">ht</span> <a class="macro-reference" href="../chapter-6.xhtml#macro-do">do</a> <span class="syntax-cons">(<a class="function-reference" href="../chapter-22.xhtml#function-print">print</a> <span class="syntax-interned-symbol">k</span>)</span>)</span>
</span></code><br/><br/>    <code><span class="syntax-root"><span class="syntax-cons">(<a class="macro-reference" href="../chapter-6.xhtml#macro-loop">loop</a> <span class="syntax-interned-symbol">for</span> <span class="syntax-interned-symbol">s</span> <span class="syntax-interned-symbol">being</span> <span class="syntax-interned-symbol">each</span> <a class="symbol-reference" href="../chapter-2.xhtml#symbol-symbol">symbol</a> <span class="syntax-interned-symbol">of</span> <span class="syntax-quote">'<span class="syntax-interned-symbol">common-lisp</span></span> <a class="macro-reference" href="../chapter-6.xhtml#macro-do">do</a> <span class="syntax-cons">(<a class="function-reference" href="../chapter-22.xhtml#function-print">print</a> <span class="syntax-interned-symbol">s</span>)</span>)</span>
</span></code><br/><br/>    <pre><code><span class="syntax-root"><span class="syntax-cons">(<a class="macro-reference" href="../chapter-18.xhtml#macro-with-hash-table-iterator">with-hash-table-iterator</a> <span class="syntax-cons">(<span class="syntax-interned-symbol">next</span> <span class="syntax-interned-symbol">ht</span>)</span>
       <span class="syntax-cons">(<a class="function-reference" href="../chapter-22.xhtml#function-print">print</a> <span class="syntax-cons">(<span class="syntax-interned-symbol">next</span>)</span>)</span>)</span>
</span></code></pre><br/><br/>    <pre><code><span class="syntax-root"><span class="syntax-cons">(<a class="macro-reference" href="../chapter-11.xhtml#macro-with-package-iterator">with-package-iterator</a> <span class="syntax-cons">(<span class="syntax-interned-symbol">next</span> <span class="syntax-quote">'<span class="syntax-interned-symbol">common-lisp</span></span> <span class="syntax-keyword-symbol">:internal</span> <span class="syntax-keyword-symbol">:external</span>)</span>
       <span class="syntax-cons">(<a class="function-reference" href="../chapter-22.xhtml#function-print">print</a> <span class="syntax-cons">(<span class="syntax-interned-symbol">next</span>)</span>)</span>)</span>
</span></code></pre><br/><br/></pre></section><section id="section-Rationale" class="section"><h2 class="section-title">Rationale</h2>  It seems silly to have needless generality in these macros, when the   next-function is already specified to have dynamic extent anyway.   The genmerality just causes a performance problem. <br/></section><section id="section-Current practice" class="section"><h2 class="section-title">Current practice</h2>  Symbolics Genera 8.0 uses the less efficient implementation that   supports reinvoking the next-function after it returns <a class="section-reference" href="../chapter-1.xhtml#section-NIL">NIL</a>. <br/>  Lucid 4.0.0 Beta-1 does not support <a class="macro-reference" href="../chapter-11.xhtml#macro-with-package-iterator">WITH-PACKAGE-ITERATOR</a> and   <a class="macro-reference" href="../chapter-18.xhtml#macro-with-hash-table-iterator">WITH-HASH-TABLE-ITERATOR</a>, but has a similar internal facility. <br/>  In both of the above implementations, <a class="macro-reference" href="../chapter-6.xhtml#macro-loop">LOOP</a> generates code that   does not call the next-function again after it returns <a class="section-reference" href="../chapter-1.xhtml#section-NIL">NIL</a>. <br/>  Other implementations were not surveyed. <br/></section><section id="section-Cost to Implementors" class="section"><h2 class="section-title">Cost to Implementors</h2>  None. <br/></section><section id="section-Cost to Users" class="section"><h2 class="section-title">Cost to Users</h2>  None. <br/></section><section id="section-Cost of non-adoption" class="section"><h2 class="section-title">Cost of non-adoption</h2>  Small performance degradation. <br/></section><section id="section-Performance impact" class="section"><h2 class="section-title">Performance impact</h2>  Small performance improvement. <br/></section><section id="section-Benefits" class="section"><h2 class="section-title">Benefits</h2>  Small performance improvement. <br/></section><section id="section-Esthetics" class="section"><h2 class="section-title">Esthetics</h2>  Not applicable to these macros. <br/></section><section id="section-Discussion" class="section"><h2 class="section-title">Discussion</h2>  None. </section></div></main><footer>Copyright © 2021 Jan Moringen</footer></body></html>