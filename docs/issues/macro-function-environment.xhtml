<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1 plus MathML 2.0//EN"
  "http://www.w3.org/Math/DTD/mathml2/xhtml-math11-f.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta charset="utf-8"/><link rel="stylesheet" type="text/css" href="../style.css"/><script src="../permalink.js"/><script src="../navigation.js"/><title>Well-specified Common Lisp — MACRO-FUNCTION-ENVIRONMENT</title></head><body><main><nav class="sidebar"><span class="name">Entry Points</span><br/><ol><li><a href="../chap-0.xhtml#section-Figures">Table of Contents</a></li><li><a href="../symbol-index.xhtml#section-SymbolIndex">Symbol Index</a></li><li><a href="../figure-index.xhtml#section-FigureIndex">Figure Index</a></li><li><a href="../issue-index.xhtml#section-IssueIndices">Issue Index</a></li><li><a href="../note-indices.xhtml#section-ReviewerNoteIndex">Note Indices</a></li><li><a href="../chapter-26.xhtml#section-Glossary">Glossary</a></li></ol><hr/><span class="name">MACRO-FUNCTION-ENVIRONMENT</span><br/><ol class="local-toc"><li><a href="#section-References">References</a><ol> </ol></li><li><a href="#section-Edit history">Edit history</a><ol> </ol></li><li><a href="#section-Problem description">Problem description</a><ol> </ol></li><li><a href="#issue-macro-function-environment:yes">Proposal YES</a><ol> </ol></li><li><a href="#section-Examples">Examples</a><ol> </ol></li><li><a href="#section-Rationale">Rationale</a><ol> </ol></li><li><a href="#section-Current practice">Current practice</a><ol> </ol></li><li><a href="#section-Cost to Implementors">Cost to Implementors</a><ol> </ol></li><li><a href="#section-Cost to Users">Cost to Users</a><ol> </ol></li><li><a href="#section-Cost of non-adoption">Cost of non-adoption</a><ol> </ol></li><li><a href="#section-Benefits">Benefits</a><ol> </ol></li><li><a href="#section-Aesthetics">Aesthetics</a><ol> </ol></li><li><a href="#section-Discussion">Discussion</a><ol> </ol></li></ol></nav><div class="content"><h1>X3J13 Issue MACRO-FUNCTION-ENVIRONMENT [NIL] [ADDITION]</h1><section id="section-References" class="section"><h2 class="section-title">References</h2><a class="function-reference" href="../chapter-3.xhtml#function-macro-function">macro-function</a>, p. 144 <a class="special-operator-reference" href="../chapter-5.xhtml#special-operator-macrolet">macrolet</a>, pp. 113-4 <a class="lambda-list-keyword-reference" href="../chapter-3.xhtml#lambda-list-keyword-environment">&amp;ENVIRONMENT</a>, pp. 145-6 <a class="function-reference" href="../chapter-3.xhtml#function-macroexpand">macroexpand</a> and <a class="function-reference" href="../chapter-3.xhtml#function-macroexpand-1">macroexpand-1</a>, pp. 151-2 </section><section id="section-Edit history" class="section"><h2 class="section-title">Edit history</h2>Version 1, Pavel, March 21, 1988 Version 2, Masinter,  8-Jun-88, (as per cleanup discussion) </section><section id="section-Problem description" class="section"><h2 class="section-title">Problem description</h2>The <a class="lambda-list-keyword-reference" href="../chapter-3.xhtml#lambda-list-keyword-environment">&amp;ENVIRONMENT</a> argument to a macro-expansion function may only be used as the second argument to the functions <a class="function-reference" href="../chapter-3.xhtml#function-macroexpand">macroexpand</a> and <a class="function-reference" href="../chapter-3.xhtml#function-macroexpand-1">macroexpand-1</a>.  It is sometimes more convenient, however, to be able to work directly with the more primitive function <a class="function-reference" href="../chapter-3.xhtml#function-macro-function">macro-function</a>, on which <a class="function-reference" href="../chapter-3.xhtml#function-macroexpand">macroexpand</a> and <a class="function-reference" href="../chapter-3.xhtml#function-macroexpand-1">macroexpand-1</a> are presumably based.  However, since <a class="function-reference" href="../chapter-3.xhtml#function-macro-function">macro-function</a> does not take an environment argument, it cannot be used in situations in which that environment must be taken into account. <br/></section><section class="status-unknown proposal" id="issue-macro-function-environment:yes"><h2 class="section-title">Proposal YES</h2>Add an optional second argument to <a class="function-reference" href="../chapter-3.xhtml#function-macro-function">macro-function</a>, that argument being an environment that was passed as the <a class="lambda-list-keyword-reference" href="../chapter-3.xhtml#lambda-list-keyword-environment">&amp;ENVIRONMENT</a> argument to some macro expansion function.  If the argument is not given, or the argument is <a class="section-reference" href="../chapter-1.xhtml#section-NIL">NIL</a>, the null environment is used.  <a class="function-reference" href="../chapter-3.xhtml#function-macro-function">macro-function</a> will now consider macro definitions from that environment in preference to ones in the global environment.  It is an error to supply the environment argument in a use of <a class="function-reference" href="../chapter-3.xhtml#function-macro-function">macro-function</a> as a <a class="macro-reference" href="../chapter-5.xhtml#macro-setf">setf</a> location specifier. <br/></section><section id="section-Examples" class="section"><h2 class="section-title">Examples</h2><pre><pre><code><span class="syntax-root"><span class="syntax-cons">(<a class="special-operator-reference" href="../chapter-5.xhtml#special-operator-macrolet">macrolet</a> <span class="syntax-cons">(<span class="syntax-cons">(<span class="syntax-interned-symbol">foo</span> <span class="syntax-cons">(<a class="lambda-list-keyword-reference" href="../chapter-3.xhtml#lambda-list-keyword-environment">&amp;ENVIRONMENT</a> <span class="syntax-interned-symbol">env</span>)</span>
              <span class="syntax-cons">(<a class="special-operator-reference" href="../chapter-5.xhtml#special-operator-if">if</a> <span class="syntax-cons">(<a class="function-reference" href="../chapter-3.xhtml#function-macro-function">macro-function</a> <span class="syntax-quote">'<span class="syntax-interned-symbol">bar</span></span> <span class="syntax-interned-symbol">env</span>)</span>
                 <span class="syntax-quote">'<span class="syntax-quote">'<span class="syntax-interned-symbol">yes</span></span></span>
                 <span class="syntax-quote">'<span class="syntax-quote">'<span class="syntax-interned-symbol">no</span></span></span>)</span>)</span>)</span>
   <span class="syntax-cons">(<a class="function-reference" href="../chapter-14.xhtml#function-list">list</a> <span class="syntax-cons">(<span class="syntax-interned-symbol">foo</span>)</span>
         <span class="syntax-cons">(<a class="special-operator-reference" href="../chapter-5.xhtml#special-operator-macrolet">macrolet</a> <span class="syntax-cons">(<span class="syntax-cons">(<span class="syntax-interned-symbol">bar</span> <span class="syntax-symbol">()</span> <span class="syntax-keyword-symbol">:beep</span>)</span>)</span>
            <span class="syntax-cons">(<span class="syntax-interned-symbol">foo</span>)</span>)</span>)</span>)</span>
</span></code></pre><br/><br/><a class="function-reference" href="../chapter-12.xhtml#function-=">=</a>&gt; <pre><code><span class="syntax-root"><span class="syntax-cons">(<span class="syntax-interned-symbol">no</span> <span class="syntax-interned-symbol">yes</span>)</span>
</span></code></pre><br/><br/><pre><code><span class="syntax-root"><span class="syntax-cons">(<a class="macro-reference" href="../chapter-5.xhtml#macro-setf">setf</a> <span class="syntax-cons">(<a class="function-reference" href="../chapter-3.xhtml#function-macro-function">macro-function</a> <span class="syntax-quote">'<span class="syntax-interned-symbol">bar</span></span> <span class="syntax-interned-symbol">env</span>)</span> <span class="syntax-interned-symbol">...</span>)</span>
</span></code></pre> is an error.<br/><br/></pre></section><section id="section-Rationale" class="section"><h2 class="section-title">Rationale</h2>Intuitively, the more primitive operation in macro expansion is <a class="function-reference" href="../chapter-3.xhtml#function-macro-function">macro-function</a>, not <a class="function-reference" href="../chapter-3.xhtml#function-macroexpand">macroexpand</a> or <a class="function-reference" href="../chapter-3.xhtml#function-macroexpand-1">macroexpand-1</a>, yet the environment argument can only be supplied to the latter functions and not to the former one.  By changing this state of affairs, the model of macro expansion becomes somewhat simpler.  Also, more flexible use of the facility is enabled. <br/></section><section id="section-Current practice" class="section"><h2 class="section-title">Current practice</h2>Xerox Common Lisp already implements this proposal.  Symbolics Common Lisp, and Kyoto Common Lisp do not. Lucid Common Lisp did not, but version 3.0 does. <br/></section><section id="section-Cost to Implementors" class="section"><h2 class="section-title">Cost to Implementors</h2>This is presumably a simple change to make, a small matter of moving the environment-searching code from <a class="function-reference" href="../chapter-3.xhtml#function-macroexpand-1">macroexpand-1</a> to <a class="function-reference" href="../chapter-3.xhtml#function-macro-function">macro-function</a>. <br/></section><section id="section-Cost to Users" class="section"><h2 class="section-title">Cost to Users</h2>The change is upward-compatible and so poses no cost to users. <br/></section><section id="section-Cost of non-adoption" class="section"><h2 class="section-title">Cost of non-adoption</h2>One more <pre><code><span class="syntax-root"><span class="syntax-cons">(<span class="syntax-interned-symbol">small</span>)</span>
</span></code></pre> semantic wart on the language. <br/></section><section id="section-Benefits" class="section"><h2 class="section-title">Benefits</h2>The function that users think of as being more primitive really is. <br/></section><section id="section-Aesthetics" class="section"><h2 class="section-title">Aesthetics</h2>This slightly cleans up the language. <br/></section><section id="section-Discussion" class="section"><h2 class="section-title">Discussion</h2>This issue was discussed starting in January 1987, but got tangled in a web of other related proposals. In its current form, the only objections have been that some other proposal or committee might otherwise change macro handling, or that this proposal doesn't fix enough of the problems. <br/></section></div></main><footer>Copyright © 2021 Jan Moringen</footer></body></html>