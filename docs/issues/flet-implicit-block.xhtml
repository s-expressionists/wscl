<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1 plus MathML 2.0//EN"
  "http://www.w3.org/Math/DTD/mathml2/xhtml-math11-f.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta charset="utf-8"/><link rel="stylesheet" type="text/css" href="../style.css"/><script src="../permalink.js"/><script src="../navigation.js"/><title>Well-specified Common Lisp — FLET-IMPLICIT-BLOCK</title></head><body><main><nav class="sidebar"><span class="name">Entry Points</span><br/><ol><li><a href="../chap-0.xhtml#section-Figures">Table of Contents</a></li><li><a href="../symbol-index.xhtml#section-SymbolIndex">Symbol Index</a></li><li><a href="../figure-index.xhtml#section-FigureIndex">Figure Index</a></li><li><a href="../issue-index.xhtml#section-IssueIndices">Issue Index</a></li><li><a href="../note-indices.xhtml#section-ReviewerNoteIndex">Note Indices</a></li><li><a href="../chapter-26.xhtml#section-Glossary">Glossary</a></li></ol><hr/><span class="name">FLET-IMPLICIT-BLOCK</span><br/><ol class="local-toc"><li><a href="#section-Status">Status</a><ol> </ol></li><li><a href="#section-References">References</a><ol> </ol></li><li><a href="#section-Edit history">Edit history</a><ol> </ol></li><li><a href="#section-Problem Description">Problem Description</a><ol> </ol></li><li><a href="#section-Test case">Test case</a><ol> </ol></li><li><a href="#issue-flet-implicit-block:yes">Proposal YES</a><ol> </ol></li><li><a href="#section-Current Practice">Current Practice</a><ol> </ol></li><li><a href="#section-Discussion">Discussion</a><ol> </ol></li></ol></nav><div class="content"><h1>X3J13 Issue FLET-IMPLICIT-BLOCK [NIL] [OMISSION ]</h1><section id="section-Status" class="status-passed section"><h2 class="section-title">Status</h2>Passed, 1988? (not sure which meeting) </section><section id="section-References" class="section"><h2 class="section-title">References</h2>CLtL p. 113, 67 </section><section id="section-Edit history" class="section"><h2 class="section-title">Edit history</h2>Version 2 by cleanup committee 15-Mar-87 <span class="issue-reference error">issue:15:13</span>:33 Version 3 by Masinter (reformatting) 7-Apr-87 <span class="issue-reference error">issue:17:49</span>:12  Versions 4,5 by Fahlman 11-Apr-87 Version 6 by Masinter  5-Jun-87 <br/></section><section id="section-Problem Description" class="section"><h2 class="section-title">Problem Description</h2>Do <a class="special-operator-reference" href="../chapter-5.xhtml#special-operator-flet">flet</a>, <a class="special-operator-reference" href="../chapter-5.xhtml#special-operator-labels">labels</a>, <a class="macro-reference" href="../chapter-3.xhtml#macro-defmacro">defmacro</a>, <a class="special-operator-reference" href="../chapter-5.xhtml#special-operator-macrolet">macrolet</a>, <a class="macro-reference" href="../chapter-5.xhtml#macro-defsetf">defsetf</a>, DEFINE-SETF-METHOD, and <a class="macro-reference" href="../chapter-4.xhtml#macro-deftype">deftype</a> have an implicit block around their bodies like the body of a <a class="macro-reference" href="../chapter-5.xhtml#macro-defun">defun</a>?  CLtL is silent on this point.  Many users and some implementors assume that such blocks should be established, since they view these forms as analogous with <a class="macro-reference" href="../chapter-5.xhtml#macro-defun">defun</a>. <br/></section><section id="section-Test case" class="section"><h2 class="section-title">Test case</h2><pre><code><span class="syntax-root"><span class="syntax-cons">(<a class="macro-reference" href="../chapter-5.xhtml#macro-defun">defun</a> <span class="syntax-interned-symbol">test</span> <span class="syntax-symbol">()</span>
  <span class="syntax-cons">(<a class="special-operator-reference" href="../chapter-5.xhtml#special-operator-flet">flet</a> <span class="syntax-cons">(<span class="syntax-cons">(<span class="syntax-interned-symbol">test</span> <span class="syntax-cons">(<span class="syntax-interned-symbol">x</span>)</span> <span class="syntax-cons">(<a class="special-operator-reference" href="../chapter-5.xhtml#special-operator-if">if</a> <span class="syntax-interned-symbol">x</span> <span class="syntax-cons">(<a class="special-operator-reference" href="../chapter-5.xhtml#special-operator-return-from">return-from</a> <span class="syntax-interned-symbol">test</span> <span class="syntax-number">4</span>)</span> <span class="syntax-number">3</span>)</span>)</span>)</span>
	<span class="syntax-cons">(<a class="function-reference" href="../chapter-14.xhtml#function-list">list</a> <span class="syntax-cons">(<span class="syntax-interned-symbol">test</span> <a class="section-reference" href="../chapter-1.xhtml#section-NIL">NIL</a>)</span> <span class="syntax-cons">(<span class="syntax-interned-symbol">test</span> <a class="section-reference" href="../chapter-26.xhtml#section-T">T</a>)</span>)</span>)</span>)</span>
</span></code></pre> <br/><code><span class="syntax-root"><span class="syntax-cons">(<span class="syntax-interned-symbol">test</span>)</span>
</span></code> <br/>will return <code><span class="syntax-root"><span class="syntax-cons">(<span class="syntax-number">3</span> <span class="syntax-number">4</span>)</span>
</span></code> if <a class="issue-reference" href="#issue-flet-implicit-block:yes">FLET-IMPLICIT-BLOCK:YES</a> is adopted, and would return 4 in an implementation that did not add an implicit block around <a class="special-operator-reference" href="../chapter-5.xhtml#special-operator-flet">flet</a>. <br/></section><section class="status-passed proposal" id="issue-flet-implicit-block:yes"><h2 class="section-title">Proposal YES</h2>Each function created by <a class="special-operator-reference" href="../chapter-5.xhtml#special-operator-flet">flet</a> and <a class="special-operator-reference" href="../chapter-5.xhtml#special-operator-labels">labels</a> and each macro created by <a class="macro-reference" href="../chapter-3.xhtml#macro-defmacro">defmacro</a> and <a class="special-operator-reference" href="../chapter-5.xhtml#special-operator-macrolet">macrolet</a> has an implicit block around the body.  The name of this block is that same as the <code><span class="syntax-root"><span class="syntax-cons">(<span class="syntax-interned-symbol">lexical</span>)</span>
</span></code> name of the function or macro.  Similarly, the body code in <a class="macro-reference" href="../chapter-5.xhtml#macro-defsetf">defsetf</a>, DEFINE-SETF-METHOD, and <a class="macro-reference" href="../chapter-4.xhtml#macro-deftype">deftype</a> is surrounded by a block with the same name as the accessor or type. <br/></section><section id="section-Current Practice" class="section"><h2 class="section-title">Current Practice</h2>Current practice is mixed.  Several implementations do not add the implicit block, others do, some add some of these blocks and not others. <br/>Cost of adopting this change: <br/>Some implementations will have to be modified.  This should be a relatively easy modification. <br/>Cost of not adopting the change: <br/>If the issue is not clarified one way or another, continuing confusion will result in portability problems.  Clarifying the issue in any other way would also require modifications in some implementations. <br/>Cost of converting existing code: <br/>It is possible that some user code would break because it does a return from within a code body to an outer block that has the same as the newly-required block.  Such problems will be rare, and the code in question would not run on all current Common Lisp systems because of the diverse interpretations currently in effect.  It would be possible to detect all such instances automatically, though it seems unlikely that anyone will need to use this technique. <br/></section><section id="section-Discussion" class="section"><h2 class="section-title">Discussion</h2>The goal is first to clean up an ambiguous situation and, second, to do this in a way that provides consistent behavior between local and global definitions.  The proposed change would allow a simple rule of thumb: any named entity that takes a code body establishes an implicit block with the obvious name. <br/>Two alternatives to the proposal were considered and rejected: <br/>The first would be to keep the implicit block in <a class="macro-reference" href="../chapter-5.xhtml#macro-defun">defun</a>, and to clearly state that the other forms do not create implicit blocks.  This violates the goal of consistency between lexical and global definitions, and it seems to conflict with users' expectations. <br/>The second alternative was to eliminate the implicit block from <a class="macro-reference" href="../chapter-5.xhtml#macro-defun">defun</a> rather than adding such blocks to other forms.  There was some feeling that specifying the implicit block in <a class="macro-reference" href="../chapter-5.xhtml#macro-defun">defun</a> was a poor design decision in the first place, since it hides a reference to the name of a function within the code of the function itself.  If a user decides to rename some function, he must be careful to rename any <a class="special-operator-reference" href="../chapter-5.xhtml#special-operator-return-from">return-from</a> forms within the body of the function as well. <br/>However, eliminating the implicit block in <a class="macro-reference" href="../chapter-5.xhtml#macro-defun">defun</a> would be a significant incompatible change.  Some users find this implicit block to be a great convenience for popping out of convoluted code, and some existing code makes heavy use of this feature.  While such code could be repaired automatically by searching for situations in which the user returns from a function by name and by adding an appropriate explicit block to any function containing such a forms, it would still require more more work on existing user code than this proposal made above. <br/>There was considerable discussion in the cleanup committee about whether these implicit blocks would interfere with tail-recursion optimization, which we hope will become more common in future Common Lisp implementations.  The outcome of these discussions was general agreement that a compiler could easily eliminate the implicit block in any case where it is not actually used, and that the impact on tail-recursion optimization in compiled code is therefore minimal. </section></div></main><footer>Copyright © 2021 Jan Moringen</footer></body></html>