<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1 plus MathML 2.0//EN"
  "http://www.w3.org/Math/DTD/mathml2/xhtml-math11-f.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta charset="utf-8"/><link rel="stylesheet" type="text/css" href="../style.css"/><script src="../permalink.js"/><script src="../navigation.js"/><title>Well-specified Common Lisp — CLOSE-CONSTRUCTED-STREAM</title></head><body><main><nav class="sidebar"><span class="name">Entry Points</span><br/><ol><li><a href="../chap-0.xhtml#section-Figures">Table of Contents</a></li><li><a href="../symbol-index.xhtml#section-SymbolIndex">Symbol Index</a></li><li><a href="../figure-index.xhtml#section-FigureIndex">Figure Index</a></li><li><a href="../issue-index.xhtml#section-IssueIndices">Issue Index</a></li><li><a href="../note-indices.xhtml#section-ReviewerNoteIndex">Note Indices</a></li><li><a href="../chapter-26.xhtml#section-Glossary">Glossary</a></li></ol><hr/><span class="name">CLOSE-CONSTRUCTED-STREAM</span><br/><ol class="local-toc"><li><a href="#section-Status">Status</a><ol> </ol></li><li><a href="#section-References">References</a><ol> </ol></li><li><a href="#section-Edit history">Edit history</a><ol> </ol></li><li><a href="#section-Problem description">Problem description</a><ol> </ol></li><li><a href="#issue-close-constructed-stream:is-error">Proposal IS-ERROR</a><ol> </ol></li><li><a href="#issue-close-constructed-stream:signals-error">Proposal SIGNALS-ERROR</a><ol> </ol></li><li><a href="#issue-close-constructed-stream:argument-stream-only">Proposal ARGUMENT-STREAM-ONLY</a><ol> </ol></li><li><a href="#issue-close-constructed-stream:close-constituents">Proposal CLOSE-CONSTITUENTS</a><ol> </ol></li><li><a href="#section-Examples">Examples</a><ol> </ol></li><li><a href="#section-Rationale">Rationale</a><ol> </ol></li><li><a href="#section-Current practice">Current practice</a><ol> </ol></li><li><a href="#section-Cost to Implementors">Cost to Implementors</a><ol> </ol></li><li><a href="#section-Cost to Users">Cost to Users</a><ol> </ol></li><li><a href="#section-Cost of non-adoption">Cost of non-adoption</a><ol> </ol></li><li><a href="#section-Performance impact">Performance impact</a><ol> </ol></li><li><a href="#section-Benefits">Benefits</a><ol> </ol></li><li><a href="#section-Esthetics">Esthetics</a><ol> </ol></li><li><a href="#section-Discussion">Discussion</a><ol> </ol></li></ol></nav><div class="content"><h1>X3J13 Issue CLOSE-CONSTRUCTED-STREAM [Cleanup] [Clarification/Change]</h1><h2>Related issues</h2><ul><li><a class="issue-reference" href="../issues/closed-stream-operations.xhtml#issue-closed-stream-operations">CLOSED-STREAM-OPERATIONS</a></li></ul><section id="section-Status" class="status-passed section"><h2 class="section-title">Status</h2>Proposal <a class="proposal-reference" href="#issue-close-constructed-stream:argument-stream-only">ARGUMENT-STREAM-ONLY</a> passed, Jan 89 X3J13  </section><section id="section-References" class="section"><h2 class="section-title">References</h2>close (CLtL p. 332), <a class="macro-reference" href="../chapter-21.xhtml#macro-with-open-stream">WITH-OPEN-STREAM</a>  (CLtL p 330), <a class="function-reference" href="../chapter-21.xhtml#function-make-synonym-stream">make-synonym-stream</a>, <a class="function-reference" href="../chapter-21.xhtml#function-make-broadcast-stream">make-broadcast-stream</a>, <a class="function-reference" href="../chapter-21.xhtml#function-make-concatenated-stream">make-concatenated-stream</a>, <a class="function-reference" href="../chapter-21.xhtml#function-make-two-way-stream">make-two-way-stream</a>, <a class="function-reference" href="../chapter-21.xhtml#function-make-echo-stream">make-echo-stream</a>, <a class="function-reference" href="../chapter-21.xhtml#function-make-string-input-stream">make-string-input-stream</a>, <a class="function-reference" href="../chapter-21.xhtml#function-make-string-output-stream">make-string-output-stream</a>, <a class="macro-reference" href="../chapter-21.xhtml#macro-with-input-from-string">with-input-from-string</a>, <a class="macro-reference" href="../chapter-21.xhtml#macro-with-output-to-string">with-output-to-string</a> </section><section id="section-Edit history" class="section"><h2 class="section-title">Edit history</h2>Masinter,  6-Jan-89, Version 1 Masinter, 12-Jan-89, Version 2 </section><section id="section-Problem description" class="section"><h2 class="section-title">Problem description</h2>First some terminology: <br/>A "composite" stream is one created with <a class="function-reference" href="../chapter-21.xhtml#function-make-synonym-stream">MAKE-SYNONYM-STREAM</a>,  <a class="function-reference" href="../chapter-21.xhtml#function-make-broadcast-stream">MAKE-BROADCAST-STREAM</a>, <a class="function-reference" href="../chapter-21.xhtml#function-make-concatenated-stream">MAKE-CONCATENATED-STREAM</a>, <a class="function-reference" href="../chapter-21.xhtml#function-make-two-way-stream">MAKE-TWO-WAY-STREAM</a>,  <a class="function-reference" href="../chapter-21.xhtml#function-make-echo-stream">MAKE-ECHO-STREAM</a>.  <br/>The "constituents" of a composite stream are the streams it points to: the <a class="function-reference" href="../chapter-10.xhtml#function-symbol-value">SYMBOL-VALUE</a> of the symbol given to <a class="function-reference" href="../chapter-21.xhtml#function-make-synonym-stream">MAKE-SYNONYM-STREAM</a> the streams given to <a class="function-reference" href="../chapter-21.xhtml#function-make-broadcast-stream">MAKE-BROADCAST-STREAM</a> or <a class="function-reference" href="../chapter-21.xhtml#function-make-concatenated-stream">MAKE-CONCATENATED-STREAM</a> the input-stream and output-stream given to <a class="function-reference" href="../chapter-21.xhtml#function-make-two-way-stream">MAKE-TWO-WAY-STREAM</a> or <a class="function-reference" href="../chapter-21.xhtml#function-make-echo-stream">MAKE-ECHO-STREAM</a>. <br/>A "constructed" stream is either a composite stream or one created with  <a class="function-reference" href="../chapter-21.xhtml#function-make-string-input-stream">MAKE-STRING-INPUT-STREAM</a>, <a class="function-reference" href="../chapter-21.xhtml#function-make-string-output-stream">MAKE-STRING-OUTPUT-STREAM</a>, <a class="macro-reference" href="../chapter-21.xhtml#macro-with-input-from-string">WITH-INPUT-FROM-STRING</a>,  <a class="macro-reference" href="../chapter-21.xhtml#macro-with-output-to-string">WITH-OUTPUT-TO-STRING</a>. <br/>The function "<a class="function-reference" href="../chapter-21.xhtml#function-close">CLOSE</a>" is currently described in 21.3, which starts "This section contains discussion of only those operations that are common to all streams."  This would seem to imply that they apply to constructed streams.  <br/>The definition of <a class="function-reference" href="../chapter-21.xhtml#function-close">CLOSE</a> "The argument must be a stream. No further input/output  operations may be performed on it. ... "  It further states "... and it is  permissible to close an already closed stream." <br/>However, the behavior on the constructed streams is not well defined, and implementations <code><span class="syntax-root"><span class="syntax-cons">(<span class="syntax-interned-symbol">apparently</span>)</span>
</span></code> differ. <br/></section><section class="status-unknown proposal" id="issue-close-constructed-stream:is-error"><h2 class="section-title">Proposal IS-ERROR</h2>It "is an error" to call <a class="function-reference" href="../chapter-21.xhtml#function-close">CLOSE</a> on a constructed stream. <a class="function-reference" href="../chapter-21.xhtml#function-close">CLOSE</a> might signal an error, or the result of <a class="function-reference" href="../chapter-21.xhtml#function-close">CLOSE</a> could cause the constituent streams to be closed, etc, but the effect is <a class="glossary-reference" href="../chapter-26.xhtml#glossary-implementation-dependent">implementation-dependent</a>. <br/></section><section class="status-unknown proposal" id="issue-close-constructed-stream:signals-error"><h2 class="section-title">Proposal SIGNALS-ERROR</h2>Calling <a class="function-reference" href="../chapter-21.xhtml#function-close">CLOSE</a> on a constructed stream signals an error. <br/></section><section class="status-passed proposal" id="issue-close-constructed-stream:argument-stream-only"><h2 class="section-title">Proposal ARGUMENT-STREAM-ONLY</h2>The effect of <a class="function-reference" href="../chapter-21.xhtml#function-close">CLOSE</a> on a constructed stream is to close the "argument" stream only. No i/o operations are permitted after the call to <a class="function-reference" href="../chapter-21.xhtml#function-close">CLOSE</a> on the stream given to <a class="function-reference" href="../chapter-21.xhtml#function-close">CLOSE</a>; There is no effect on the constituents of composite streams. <br/>For streams created with <a class="function-reference" href="../chapter-21.xhtml#function-make-string-output-stream">MAKE-STRING-OUTPUT-STREAM</a>, the result of <a class="function-reference" href="../chapter-21.xhtml#function-get-output-stream-string">GET-OUTPUT-STREAM-STRING</a> is unspecified after CLOS. For composite streams, the call to <a class="function-reference" href="../chapter-21.xhtml#function-close">CLOSE</a> has no effect on any of the constituent streams. <br/>The "links" to the constituents may be broken; if the proposal in <a class="issue-reference" href="../issues/stream-access.xhtml#issue-stream-access">STREAM-ACCESS</a>  passes, the results of the accessor functions there are unspecified after the call to <a class="function-reference" href="../chapter-21.xhtml#function-close">CLOSE</a>.) <br/></section><section class="status-unknown proposal" id="issue-close-constructed-stream:close-constituents"><h2 class="section-title">Proposal CLOSE-CONSTITUENTS</h2><a class="function-reference" href="../chapter-21.xhtml#function-close">CLOSE</a> first closes its argument; it then operates recursively on the constituents of composite streams. <br/></section><section id="section-Examples" class="section"><h2 class="section-title">Examples</h2><pre>&gt;&gt;not written; sorry&lt;&lt;<br/><br/></pre></section><section id="section-Rationale" class="section"><h2 class="section-title">Rationale</h2>Specifying seems better than not saying what happens, even if it is "<a class="glossary-reference" href="../chapter-26.xhtml#glossary-implementation-dependent">implementation-dependent</a>". <br/></section><section id="section-Current practice" class="section"><h2 class="section-title">Current practice</h2>Implementations seem to vary widely. <br/></section><section id="section-Cost to Implementors" class="section"><h2 class="section-title">Cost to Implementors</h2>Varying, depending on the current level of conformance. Making the changes themselves is probably trivial <pre><code><span class="syntax-root"><span class="syntax-cons">(<span class="syntax-interned-symbol">to</span> <a class="special-operator-reference" href="../chapter-3.xhtml#special-operator-the">the</a> <span class="syntax-string">"close"</span> <a class="type-reference" href="../chapter-4.xhtml#type-method">method</a> <span class="syntax-interned-symbol">for</span> <span class="syntax-interned-symbol">each</span> <span class="syntax-interned-symbol">kind</span> <span class="syntax-interned-symbol">of</span>
<span class="syntax-interned-symbol">constructed</span> <a class="type-reference" href="../chapter-21.xhtml#type-stream">stream</a> <a class="symbol-reference" href="../chapter-25.xhtml#symbol-type">type</a>)</span>
</span></code></pre> but it is possible that system code might depend on the behavior. <br/></section><section id="section-Cost to Users" class="section"><h2 class="section-title">Cost to Users</h2>Likely small; we've not found any good uses for <a class="function-reference" href="../chapter-21.xhtml#function-close">CLOSE</a> on composite streams. <br/></section><section id="section-Cost of non-adoption" class="section"><h2 class="section-title">Cost of non-adoption</h2>Continued minor ambiguity <br/></section><section id="section-Performance impact" class="section"><h2 class="section-title">Performance impact</h2>near zero <br/></section><section id="section-Benefits" class="section"><h2 class="section-title">Benefits</h2>The language would be more well specified. <br/></section><section id="section-Esthetics" class="section"><h2 class="section-title">Esthetics</h2>Well-specified languages are usually easier to deal with. <br/></section><section id="section-Discussion" class="section"><h2 class="section-title">Discussion</h2>Signalling an error is reasonable if no Common Lisp program ever needs to call <a class="function-reference" href="../chapter-21.xhtml#function-close">CLOSE</a> on a composite stream. We could not come up with a legitimate case where you wouldn't instead close the underlying stream if that's what you wanted. <br/>Allowing the result to be implementation dependent is the "status quo".  <br/><a class="proposal-reference" href="#issue-close-constructed-stream:argument-stream-only">ARGUMENT-STREAM-ONLY</a> is probably the "safest" in that it makes it harder to accidentally close a stream that wasn't intended. It seems counterintuitive and yet it probably wouldn't be harmful if it were well-defined that this was what it did. <br/><a class="proposal-reference" href="#issue-close-constructed-stream:close-constituents">CLOSE-CONSTITUENTS</a> could be an incompatible change for some implementations. It makes more sense for things like broadcast streams <code><span class="syntax-root"><span class="syntax-cons">(<span class="syntax-interned-symbol">which</span> <span class="syntax-interned-symbol">are</span> <span class="syntax-interned-symbol">usually</span> <span class="syntax-interned-symbol">non-interactive</span>)</span>
</span></code> than it does for echo streams <code><span class="syntax-root"><span class="syntax-cons">(<span class="syntax-interned-symbol">which</span> <span class="syntax-interned-symbol">are</span> <span class="syntax-interned-symbol">sometimes</span> <span class="syntax-interned-symbol">interactive</span>)</span>
</span></code>. </section></div></main><footer>Copyright © 2021 Jan Moringen</footer></body></html>