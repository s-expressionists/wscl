<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1 plus MathML 2.0//EN"
  "http://www.w3.org/Math/DTD/mathml2/xhtml-math11-f.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta charset="utf-8"/><link rel="stylesheet" type="text/css" href="../style.css"/><script src="../permalink.js"/><script src="../navigation.js"/><title>Well-specified Common Lisp — WITH-OUTPUT-TO-STRING-APPEND-STYLE</title></head><body><main><nav class="sidebar"><span class="name">Entry Points</span><br/><ol><li><a href="../chap-0.xhtml#section-Figures">Table of Contents</a></li><li><a href="../symbol-index.xhtml#section-SymbolIndex">Symbol Index</a></li><li><a href="../figure-index.xhtml#section-FigureIndex">Figure Index</a></li><li><a href="../issue-index.xhtml#section-IssueIndices">Issue Index</a></li><li><a href="../note-indices.xhtml#section-ReviewerNoteIndex">Note Indices</a></li><li><a href="../chapter-26.xhtml#section-Glossary">Glossary</a></li></ol><hr/><span class="name">WITH-OUTPUT-TO-STRING-APPEND-STYLE</span><br/><ol class="local-toc"><li><a href="#section-References">References</a><ol> </ol></li><li><a href="#section-Edit history">Edit history</a><ol> </ol></li><li><a href="#section-Problem description">Problem description</a><ol> </ol></li><li><a href="#issue-with-output-to-string-append-style:vector-push-extend">Proposal VECTOR-PUSH-EXTEND</a><ol> </ol></li><li><a href="#section-Test Case">Test Case</a><ol> </ol></li><li><a href="#section-Rationale">Rationale</a><ol> </ol></li><li><a href="#section-Current Practice">Current Practice</a><ol> </ol></li><li><a href="#section-Cost to Implementors">Cost to Implementors</a><ol> </ol></li><li><a href="#section-Cost to Users">Cost to Users</a><ol> </ol></li><li><a href="#section-Benefits">Benefits</a><ol> </ol></li><li><a href="#section-Aesthetics">Aesthetics</a><ol> </ol></li><li><a href="#section-Discussion">Discussion</a><ol> </ol></li></ol></nav><div class="content"><h1>X3J13 Issue WITH-OUTPUT-TO-STRING-APPEND-STYLE [NIL] [CLARIFICATION]</h1><section id="section-References" class="section"><h2 class="section-title">References</h2>CLtL, pages 331, 386 </section><section id="section-Edit history" class="section"><h2 class="section-title">Edit history</h2>Version 1, 25-Mar-88 JonL Version 2, 29-Mar-88 JonL (fix typos; comments by Daniels) Version 3, 23-May-88 JonL (fix nits raised by Masinter) Version 4, 23-May-88 JonL (change issue name &ndash; only 1 proposal) Version 5,  7-Jun-88 Masinter (more nits) </section><section id="section-Problem description" class="section"><h2 class="section-title">Problem description</h2>CLtL p386 says that FORMATting to a <a class="function-reference" href="../chapter-15.xhtml#function-fill-pointer">fill-pointer</a>'d string should add characters "as if by use of <a class="function-reference" href="../chapter-15.xhtml#function-vector-push-extend">vector-push-extend</a>"; but CLtL p331 says that <a class="macro-reference" href="../chapter-21.xhtml#macro-with-output-to-string">with-output-to-string</a> will work "as if using <a class="function-reference" href="../chapter-15.xhtml#function-vector-push-extend">vector-push-extend</a> if the string is adjustable, and otherwise as if using <a class="function-reference" href="../chapter-15.xhtml#function-vector-push">vector-push</a>".  It's very unlikely that the original authors of these parts intended differing semantics for these two cases.  Furthermore, the semantics for <a class="macro-reference" href="../chapter-21.xhtml#macro-with-output-to-string">with-output-to-string</a> permit the inconspicuous loss of characters written to the string, since <a class="function-reference" href="../chapter-15.xhtml#function-vector-push">vector-push</a> will just "drop on the floor" any characters that would go beyond the end. <br/></section><section class="status-unknown proposal" id="issue-with-output-to-string-append-style:vector-push-extend"><h2 class="section-title">Proposal VECTOR-PUSH-EXTEND</h2>Change the documentation of <a class="macro-reference" href="../chapter-21.xhtml#macro-with-output-to-string">with-output-to-string</a> to be like that under  <a class="function-reference" href="../chapter-22.xhtml#function-format">format</a>.  That is, replace the first sentence of the next-to-last paragraph  on CLtL p331 by:   "If *string* is specified, it must be a string with a fill pointer;     the output is incrementally appended to the string <pre><code><span class="syntax-root"><span class="syntax-cons">(<span class="syntax-interned-symbol">as</span> <a class="special-operator-reference" href="../chapter-5.xhtml#special-operator-if">if</a> <span class="syntax-interned-symbol">by</span> <span class="syntax-interned-symbol">use</span> <span class="syntax-interned-symbol">of</span>
   <a class="function-reference" href="../chapter-15.xhtml#function-vector-push-extend">vector-push-extend</a>)</span>
</span></code></pre>." <br/></section><section id="section-Test Case" class="section"><h2 class="section-title">Test Case</h2><pre>    <pre><code><span class="syntax-root"><span class="syntax-cons">(<a class="special-operator-reference" href="../chapter-5.xhtml#special-operator-let">let</a> <span class="syntax-cons">(<span class="syntax-cons">(<span class="syntax-interned-symbol">str</span> <span class="syntax-cons">(<a class="function-reference" href="../chapter-15.xhtml#function-make-array">make-array</a> <span class="syntax-number">4</span> <span class="syntax-keyword-symbol">:element-type</span> <span class="syntax-quote">'<span class="syntax-interned-symbol">string-char</span></span> <span class="syntax-keyword-symbol">:fill-pointer</span> <span class="syntax-number">0</span>)</span>)</span>)</span>
      <span class="syntax-cons">(<a class="macro-reference" href="../chapter-21.xhtml#macro-with-output-to-string">with-output-to-string</a> <span class="syntax-cons">(<span class="syntax-interned-symbol">s</span> <span class="syntax-interned-symbol">str</span>)</span> <span class="syntax-cons">(<a class="function-reference" href="../chapter-22.xhtml#function-princ">princ</a> <span class="syntax-string">"You Luz, Bunkie!"</span> <span class="syntax-interned-symbol">s</span>)</span>)</span>
      <span class="syntax-interned-symbol">str</span>)</span>
</span></code></pre><br/>CLtL behaviour will return "You "; proposed behaviour will signal an error.<br/><br/></pre></section><section id="section-Rationale" class="section"><h2 class="section-title">Rationale</h2>It's unlikely that the mention of <a class="function-reference" href="../chapter-15.xhtml#function-vector-push">vector-push</a> in CLtL p331 was intended to suggest that characters could be quietly "dropped on the floor".  In any case, there is no practical or theoretical reason to make <a class="function-reference" href="../chapter-22.xhtml#function-format">format</a> and <a class="macro-reference" href="../chapter-21.xhtml#macro-with-output-to-string">with-output-to-string</a> act differently on non-adjustable strings. <br/></section><section id="section-Current Practice" class="section"><h2 class="section-title">Current Practice</h2>VaxLisp 2.2 and Lucid 3.0 implement the proposal; Lucid 2.1 and earlier versions implement CLtL.  For <a class="macro-reference" href="../chapter-21.xhtml#macro-with-output-to-string">with-output-to-string</a>, Xerox Common Lisp  implements CLtL.  Symbolics Genera 7.2 implements the proposal. <br/></section><section id="section-Cost to Implementors" class="section"><h2 class="section-title">Cost to Implementors</h2>Very small. <br/></section><section id="section-Cost to Users" class="section"><h2 class="section-title">Cost to Users</h2>Virtually none. <br/></section><section id="section-Benefits" class="section"><h2 class="section-title">Benefits</h2>Less special-casing in the semantics of "printing" to strings. More conformity with naive expectations about printing to strings. <br/></section><section id="section-Aesthetics" class="section"><h2 class="section-title">Aesthetics</h2>Minor impact. <br/></section><section id="section-Discussion" class="section"><h2 class="section-title">Discussion</h2>Implementations may want to actually call <a class="function-reference" href="../chapter-15.xhtml#function-vector-push">vector-push</a>, rather than <a class="function-reference" href="../chapter-15.xhtml#function-vector-push-extend">vector-push-extend</a>, on non-adjustable string in order to test the result &ndash; nil means an overflow of the total length of the string;  thus they may signal an error more directly related to the problem, rather than permitting <a class="function-reference" href="../chapter-15.xhtml#function-vector-push-extend">vector-push-extend</a> to complain about a non<a class="function-reference" href="../chapter-12.xhtml#function--">-</a> adjustable array.  But either way, the semantics is still that of <a class="function-reference" href="../chapter-15.xhtml#function-vector-push-extend">vector-push-extend</a>: when you get to the end of the string, adjustable  strings are extended, and non-adjustable strings cause error signals. <br/>It's perfectly acceptable to use <a class="function-reference" href="../chapter-15.xhtml#function-vector-push-extend">vector-push-extend</a> with a non-adjustable array.  It's the error-signalling property of <a class="function-reference" href="../chapter-15.xhtml#function-vector-push-extend">vector-push-extend</a>, as opposed to the "dropping on the floor" of <a class="function-reference" href="../chapter-15.xhtml#function-vector-push">vector-push</a>, that motivated this proposal. </section></div></main><footer>Copyright © 2021 Jan Moringen</footer></body></html>