<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1 plus MathML 2.0//EN"
  "http://www.w3.org/Math/DTD/mathml2/xhtml-math11-f.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta charset="utf-8"/><link rel="stylesheet" type="text/css" href="../style.css"/><script src="../permalink.js"/><script src="../navigation.js"/><title>Well-specified Common Lisp — ADJUST-ARRAY-DISPLACEMENT</title></head><body><main><nav class="sidebar"><span class="name">Entry Points</span><br/><ol><li><a href="../chap-0.xhtml#section-Figures">Table of Contents</a></li><li><a href="../symbol-index.xhtml#section-SymbolIndex">Symbol Index</a></li><li><a href="../figure-index.xhtml#section-FigureIndex">Figure Index</a></li><li><a href="../issue-index.xhtml#section-IssueIndices">Issue Index</a></li><li><a href="../note-indices.xhtml#section-ReviewerNoteIndex">Note Indices</a></li><li><a href="../chapter-26.xhtml#section-Glossary">Glossary</a></li></ol><hr/><span class="name">ADJUST-ARRAY-DISPLACEMENT</span><br/><ol class="local-toc"><li><a href="#section-Status">Status</a><ol> </ol></li><li><a href="#section-References">References</a><ol> </ol></li><li><a href="#section-Edit history">Edit history</a><ol> </ol></li><li><a href="#section-Problem Description">Problem Description</a><ol> </ol></li><li><a href="#issue-adjust-array-displaycement:rules">Proposal RULES</a><ol> </ol></li><li><a href="#section-Note">Note</a><ol> </ol></li><li><a href="#section-Rationale">Rationale</a><ol> </ol></li><li><a href="#section-Current Practice">Current Practice</a><ol> </ol></li><li><a href="#section-Cost to implementors">Cost to implementors</a><ol> </ol></li><li><a href="#section-Cost to users">Cost to users</a><ol> </ol></li><li><a href="#section-Benefits">Benefits</a><ol> </ol></li><li><a href="#section-Discussion">Discussion</a><ol> </ol></li></ol></nav><div class="content"><h1>X3J13 Issue ADJUST-ARRAY-DISPLACEMENT [NIL] [Clarification]</h1><section id="section-Status" class="status-passed section"><h2 class="section-title">Status</h2>passed, 1988 (not sure which meeting) </section><section id="section-References" class="section"><h2 class="section-title">References</h2><a class="function-reference" href="../chapter-15.xhtml#function-adjust-array">adjust-array</a> (CLtL p.297) </section><section id="section-Edit history" class="section"><h2 class="section-title">Edit history</h2>Version 1 by Fahlman, 18-Apr-87 (from Steele's list) Version 2 by Masinter Version 3 by Masinter, 5-Jun-87 (respond to comments) Version 4 by Masinter, 23-Nov-87 </section><section id="section-Problem Description" class="section"><h2 class="section-title">Problem Description</h2>The interaction of <a class="function-reference" href="../chapter-15.xhtml#function-adjust-array">adjust-array</a> and displaced arrays is insufficiently specified in the case where the array being adjusted is displaced.   <br/></section><section class="status-passed proposal" id="issue-adjust-array-displaycement:rules"><h2 class="section-title">Proposal RULES</h2>Interaction of adjusting and displacement: <br/>Suppose we are adjusting array A, which is perhaps displaced to B before the <a class="function-reference" href="../chapter-15.xhtml#function-adjust-array">adjust-array</a> call and perhaps to C after the call. <br/><ol><li> A is not displaced before or after: The dimensions of A are altered, and the contents rearranged as appropriate.  Additional elements of A are taken from the :INITIAL-ELEMENT.  The use of :INITIAL-CONTENTS causes all old contents to be discarded. </li><li> A is not displaced before, but is displaced to C after.  As specified in CLtL, none of the original contents of A appears in A afterwards; A now contains the contents of C, without any rearrangement of C. </li><li> A is displaced to B before the call, and is displaced to C after the call.  (B and C may be the same.) As in case <pre><code><span class="syntax-root"><span class="syntax-cons">(<span class="syntax-number">2</span>)</span>
</span></code></pre>, the contents of B do not appear in A afterward <pre><code><span class="syntax-root"><span class="syntax-cons">(<a class="macro-reference" href="../chapter-5.xhtml#macro-unless">unless</a> <span class="syntax-interned-symbol">such</span> <span class="syntax-interned-symbol">contents</span> <span class="syntax-interned-symbol">also</span> <span class="syntax-interned-symbol">happen</span> <span class="syntax-interned-symbol">to</span> <span class="syntax-interned-symbol">be</span> <span class="syntax-interned-symbol">in</span> <span class="syntax-interned-symbol">C</span>)</span>
</span></code></pre>.  If :DISPLACED-INDEX-OFFSET is not specified in the <a class="function-reference" href="../chapter-15.xhtml#function-adjust-array">adjust-array</a> call, it defaults to zero; the old offset <pre><code><span class="syntax-root"><span class="syntax-cons">(<span class="syntax-interned-symbol">into</span> <span class="syntax-interned-symbol">B</span>)</span>
</span></code></pre> is not retained. </li><li> A is displaced to B before the call, but not displaced afterward.  A gets a new "data region", and contents of B are copied into it as appropriate to maintain the existing old contents; additional elements of A are taken from the :INITIAL-ELEMENT.  However, the use of :INITIAL-CONTENTS causes all old contents to be discarded. If array X is displaced to array Y, and array Y is displaced to array Z, and array Y is altered by <a class="function-reference" href="../chapter-15.xhtml#function-adjust-array">adjust-array</a>, array X must now refer to the adjusted contents of Y.  This means that an implementation may not collapse the chain to make X refer to Z directly and forget that the chain of reference passes through array Y.  (Cacheing techniques are of course permitted, as long as they preserve the semantics specified here and in CLtL.) <br/>If X is displaced to Y, it is an error to adjust Y in such a way that it no longer has enough elements to satisfy X.  This error may be signalled at the time of the adjustment, but this is not required. <br/></li></ol></section><section id="section-Note" class="section"><h2 class="section-title">Note</h2>Omitting the :DISPLACED-TO argument to <a class="function-reference" href="../chapter-15.xhtml#function-adjust-array">adjust-array</a> is equivalent to specifying :DISPLACED-TO <a class="section-reference" href="../chapter-1.xhtml#section-NIL">NIL</a>; in either case, the array is not displaced after the call and case <pre><code><span class="syntax-root"><span class="syntax-cons">(<span class="syntax-number">1</span>)</span>
</span></code></pre> or <pre><code><span class="syntax-root"><span class="syntax-cons">(<span class="syntax-number">4</span>)</span>
</span></code></pre> hold. </section><section id="section-Rationale" class="section"><h2 class="section-title">Rationale</h2>This interaction must be clarified.  This set of rules was proposed some time ago, as a result of discussions on the Common Lisp mailing list, and this model has been adopted by many Common Lisp implementations. <br/></section><section id="section-Current Practice" class="section"><h2 class="section-title">Current Practice</h2>Many implementations currently follow the model proposed here, although they differ in some detail. For example, Symbolics Common Lisp behaves as indicated  except for case <pre><code><span class="syntax-root"><span class="syntax-cons">(<span class="syntax-number">4</span>)</span>
</span></code></pre>; in that case, it never copies the contents of B, and all elements are taken from the :INITIAL-ELEMENT. <br/></section><section id="section-Cost to implementors" class="section"><h2 class="section-title">Cost to implementors</h2>Some existing implementations may have to be changed, but adopting any other model would be worse.  Public-domain code implementing this model is available from CMU. <br/></section><section id="section-Cost to users" class="section"><h2 class="section-title">Cost to users</h2>This is a relatively uncommon situation, which is the reason it didn't occur to the original language designers to specify how it works.  Any user code that cares about this issue probably already follows the proposed model. <br/></section><section id="section-Benefits" class="section"><h2 class="section-title">Benefits</h2>Clarification of a situation that is currently not addressed by the standard. <br/></section><section id="section-Discussion" class="section"><h2 class="section-title">Discussion</h2>The cleanup committee supports this clarification. <br/>Some consideration was given to adding DISPLACED-ARRAY-P or ARRAY-DISPLACED-TO and ARRAY-DISPLACED-INDEX-OFFSET which would allow access to information as to whether an array was or was not displaced. However, these are not part of the current proposal. <br/>A similar issue arises with <a class="function-reference" href="../chapter-15.xhtml#function-adjust-array">adjust-array</a> and fill pointers, and will be the subject of a separate issue. </section></div></main><footer>Copyright © 2021 Jan Moringen</footer></body></html>