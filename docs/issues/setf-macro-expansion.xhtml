<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1 plus MathML 2.0//EN"
  "http://www.w3.org/Math/DTD/mathml2/xhtml-math11-f.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta charset="utf-8"/><link rel="stylesheet" type="text/css" href="../style.css"/><script src="../permalink.js"/><script src="../navigation.js"/><title>Well-specified Common Lisp — SETF-MACRO-EXPANSION</title></head><body><main><nav class="sidebar"><span class="name">Entry Points</span><br/><ol><li><a href="../chap-0.xhtml#section-Figures">Table of Contents</a></li><li><a href="../symbol-index.xhtml#section-SymbolIndex">Symbol Index</a></li><li><a href="../figure-index.xhtml#section-FigureIndex">Figure Index</a></li><li><a href="../issue-index.xhtml#section-IssueIndices">Issue Index</a></li><li><a href="../note-indices.xhtml#section-ReviewerNoteIndex">Note Indices</a></li><li><a href="../chapter-26.xhtml#section-Glossary">Glossary</a></li></ol><hr/><span class="name">SETF-MACRO-EXPANSION</span><br/><ol class="local-toc"><li><a href="#section-References">References</a><ol> </ol></li><li><a href="#section-Edit history">Edit history</a><ol> </ol></li><li><a href="#section-Problem description">Problem description</a><ol> </ol></li><li><a href="#issue-setf-macro-expansion:last">Proposal LAST</a><ol> </ol></li><li><a href="#section-Examples">Examples</a><ol> </ol></li><li><a href="#section-Rationale">Rationale</a><ol> </ol></li><li><a href="#section-Current practice">Current practice</a><ol> </ol></li><li><a href="#section-Cost to Implementors">Cost to Implementors</a><ol> </ol></li><li><a href="#section-Cost to Users">Cost to Users</a><ol> </ol></li><li><a href="#section-Cost of non-adoption">Cost of non-adoption</a><ol> </ol></li><li><a href="#section-Performance impact">Performance impact</a><ol> </ol></li><li><a href="#section-Benefits">Benefits</a><ol> </ol></li><li><a href="#section-Esthetics">Esthetics</a><ol> </ol></li><li><a href="#section-Discussion">Discussion</a><ol> </ol></li></ol></nav><div class="content"><h1>X3J13 Issue SETF-MACRO-EXPANSION [NIL] [CLARIFICATION]</h1><h2>Related issues</h2><ul><a class="issue-reference" href="../issues/function-name.xhtml#issue-function-name:large">FUNCTION-NAME:LARGE</a></ul><section id="section-References" class="section"><h2 class="section-title">References</h2><a class="macro-reference" href="../chapter-5.xhtml#macro-defsetf">defsetf</a>, DEFINE-SETF-METHOD, <a class="macro-reference" href="../chapter-5.xhtml#macro-setf">setf</a> CLtL pages 97, 102, 105 ANSI <a class="package-reference" href="../chapter-11.xhtml#package-cl">cl</a> spec 6-162 (Sep 89 version) </section><section id="section-Edit history" class="section"><h2 class="section-title">Edit history</h2>29-Apr-90, Version 1 by Moon </section><section id="section-Problem description" class="section"><h2 class="section-title">Problem description</h2>  CLtL is inconsistent because pages 102 and 105 say <a class="macro-reference" href="../chapter-5.xhtml#macro-defsetf">defsetf</a> and   DEFINE-SETF-METHOD can be used with a function or a macro, while page 97   says that <a class="macro-reference" href="../chapter-5.xhtml#macro-setf">setf</a> expands macros before it looks for setf-methods. <br/>  This is Symbolics issue #9. <br/></section><section class="status-unknown proposal" id="issue-setf-macro-expansion:last"><h2 class="section-title">Proposal LAST</h2>  Clarify that <a class="macro-reference" href="../chapter-5.xhtml#macro-setf">setf</a> <code><span class="syntax-root"><span class="syntax-cons">(<span class="syntax-interned-symbol">actually</span> <span class="syntax-interned-symbol">GET-SETF-METHOD-MULTIPLE-VALUE</span>)</span>
</span></code> only expands   macros after exhausting all other possibilities other than expanding into   a call to a function named <code><span class="syntax-root"><span class="syntax-cons">(<a class="macro-reference" href="../chapter-5.xhtml#macro-setf">setf</a> <span class="syntax-interned-symbol">reader</span>)</span>
</span></code>.  Clarify that it expands macros   in the style of <a class="function-reference" href="../chapter-3.xhtml#function-macroexpand-1">macroexpand-1</a> rather than <a class="function-reference" href="../chapter-3.xhtml#function-macroexpand">macroexpand</a> <pre><code><span class="syntax-root"><span class="syntax-cons">(<span class="syntax-interned-symbol">this</span> <span class="syntax-interned-symbol">was</span> <span class="syntax-interned-symbol">point</span> <span class="syntax-number">11</span>
  <span class="syntax-interned-symbol">of</span> <span class="syntax-interned-symbol">FUNCTION-NAME:LARGE</span> <a class="macro-reference" href="../chapter-5.xhtml#macro-and">and</a> <span class="syntax-interned-symbol">is</span> <span class="syntax-interned-symbol">repeated</span> <span class="syntax-interned-symbol">here</span> <span class="syntax-interned-symbol">for</span> <span class="syntax-interned-symbol">clarity</span> <span class="syntax-interned-symbol">only</span>)</span>
</span></code></pre>. <br/></section><section id="section-Examples" class="section"><h2 class="section-title">Examples</h2><pre>  <code><span class="syntax-root"><span class="syntax-cons">(<a class="macro-reference" href="../chapter-5.xhtml#macro-defvar">defvar</a> <span class="syntax-interned-symbol">*foo-trace*</span> <a class="section-reference" href="../chapter-1.xhtml#section-NIL">NIL</a>)</span>
</span></code><br/><br/>  <code><span class="syntax-root"><span class="syntax-cons">(<a class="macro-reference" href="../chapter-3.xhtml#macro-defmacro">defmacro</a> <span class="syntax-interned-symbol">foo</span> <span class="syntax-cons">(<span class="syntax-interned-symbol">x</span> <span class="syntax-interned-symbol">y</span>)</span> <span class="syntax-quasiquote">`<span class="syntax-cons">(<a class="function-reference" href="../chapter-15.xhtml#function-aref">aref</a> <span class="syntax-unquote">,<span class="syntax-interned-symbol">x</span></span> <span class="syntax-unquote">,<span class="syntax-interned-symbol">y</span></span>)</span></span>)</span>
</span></code><br/><br/>  <pre><code><span class="syntax-root"><span class="syntax-cons">(<a class="macro-reference" href="../chapter-5.xhtml#macro-defun">defun</a> <span class="syntax-cons">(<a class="macro-reference" href="../chapter-5.xhtml#macro-setf">setf</a> <span class="syntax-interned-symbol">foo</span>)</span> <span class="syntax-cons">(<span class="syntax-interned-symbol">z</span> <span class="syntax-interned-symbol">x</span> <span class="syntax-interned-symbol">y</span>)</span>	<span class="syntax-line-comment syntax-comment">;wrong
</span>    <span class="syntax-cons">(<a class="macro-reference" href="../chapter-14.xhtml#macro-push">push</a> <span class="syntax-quasiquote">`<span class="syntax-cons">(<span class="syntax-unquote">,<span class="syntax-interned-symbol">x</span></span> <span class="syntax-unquote">,<span class="syntax-interned-symbol">y</span></span> <span class="syntax-unquote">,<span class="syntax-interned-symbol">z</span></span>)</span></span> <span class="syntax-interned-symbol">*foo-trace*</span>)</span>
    <span class="syntax-cons">(<a class="macro-reference" href="../chapter-5.xhtml#macro-setf">setf</a> <span class="syntax-cons">(<a class="function-reference" href="../chapter-15.xhtml#function-aref">aref</a> <span class="syntax-interned-symbol">x</span> <span class="syntax-interned-symbol">y</span>)</span> <span class="syntax-interned-symbol">z</span>)</span>)</span>
</span></code></pre><br/><br/>  <pre><code><span class="syntax-root"><span class="syntax-cons">(<a class="macro-reference" href="../chapter-5.xhtml#macro-defsetf">defsetf</a> <span class="syntax-interned-symbol">foo</span> <span class="syntax-cons">(<span class="syntax-interned-symbol">x</span> <span class="syntax-interned-symbol">y</span>)</span> <span class="syntax-cons">(<span class="syntax-interned-symbol">z</span>)</span>	<span class="syntax-line-comment syntax-comment">;right
</span>    <span class="syntax-quasiquote">`<span class="syntax-cons">(<a class="special-operator-reference" href="../chapter-5.xhtml#special-operator-progn">progn</a>
       <span class="syntax-cons">(<a class="macro-reference" href="../chapter-14.xhtml#macro-push">push</a> <span class="syntax-quasiquote">`<span class="syntax-cons">(<span class="syntax-unquote">,<span class="syntax-unquote">,<span class="syntax-interned-symbol">x</span></span></span> <span class="syntax-unquote">,<span class="syntax-unquote">,<span class="syntax-interned-symbol">y</span></span></span> <span class="syntax-unquote">,<span class="syntax-unquote">,<span class="syntax-interned-symbol">z</span></span></span>)</span></span> <span class="syntax-interned-symbol">*foo-trace*</span>)</span>
       <span class="syntax-cons">(<a class="macro-reference" href="../chapter-5.xhtml#macro-setf">setf</a> <span class="syntax-cons">(<a class="function-reference" href="../chapter-15.xhtml#function-aref">aref</a> <span class="syntax-unquote">,<span class="syntax-interned-symbol">x</span></span> <span class="syntax-unquote">,<span class="syntax-interned-symbol">y</span></span>)</span> <span class="syntax-unquote">,<span class="syntax-interned-symbol">z</span></span>)</span>)</span></span>)</span>
</span></code></pre><br/><br/>  <code><span class="syntax-root"><span class="syntax-cons">(<a class="function-reference" href="../chapter-3.xhtml#function-macroexpand-1">macroexpand-1</a> <span class="syntax-quote">'<span class="syntax-cons">(<a class="macro-reference" href="../chapter-5.xhtml#macro-setf">setf</a> <span class="syntax-cons">(<span class="syntax-interned-symbol">foo</span> <a class="symbol-reference" href="../chapter-2.xhtml#symbol-array">array</a> <span class="syntax-interned-symbol">i</span>)</span> <span class="syntax-cons">(<span class="syntax-interned-symbol">val</span>)</span>)</span></span>)</span>
</span></code><br/><br/>  The last form should include a push onto *foo-trace*, rather than<br/>  first macroexpanding <code><span class="syntax-root"><span class="syntax-cons">(<span class="syntax-interned-symbol">foo</span> <a class="symbol-reference" href="../chapter-2.xhtml#symbol-array">array</a> <span class="syntax-interned-symbol">i</span>)</span>
</span></code> into <code><span class="syntax-root"><span class="syntax-cons">(<a class="function-reference" href="../chapter-15.xhtml#function-aref">aref</a> <a class="symbol-reference" href="../chapter-2.xhtml#symbol-array">array</a> <span class="syntax-interned-symbol">i</span>)</span>
</span></code> and then<br/>  setf'ing that.<br/><br/>  The defun form has no effect because <a class="macro-reference" href="../chapter-5.xhtml#macro-setf">setf</a> expands macros before expanding<br/>  into a call to such a function, so this function will not be used.<br/><br/></pre></section><section id="section-Rationale" class="section"><h2 class="section-title">Rationale</h2>  In the absence of this clarification, the language specification is not   self-consistent.  The example given above will not work in implementations   that chose to believe CLtL page 97 rather than page 102. <br/>  The rationale for <a class="issue-reference" href="../issues/function-name.xhtml#issue-function-name:large">FUNCTION-NAME:LARGE</a> point 11 suggests that we thought   we had exchanged the two bullets on page 97, so that <a class="macro-reference" href="../chapter-5.xhtml#macro-setf">setf</a> looks for setf   methods before it expands macros.  However there doesn't seem to be any   cleanup issue that explicitly addresses this. <br/></section><section id="section-Current practice" class="section"><h2 class="section-title">Current practice</h2>  Symbolics Genera looks for setf methods before expanding macros, I didn't   check any other implementations. <br/></section><section id="section-Cost to Implementors" class="section"><h2 class="section-title">Cost to Implementors</h2>  Trivial. <br/></section><section id="section-Cost to Users" class="section"><h2 class="section-title">Cost to Users</h2>  None. <br/></section><section id="section-Cost of non-adoption" class="section"><h2 class="section-title">Cost of non-adoption</h2>  The Common Lisp language will be a joke. <br/></section><section id="section-Performance impact" class="section"><h2 class="section-title">Performance impact</h2>  None. <br/></section><section id="section-Benefits" class="section"><h2 class="section-title">Benefits</h2>  Consistency. <br/></section><section id="section-Esthetics" class="section"><h2 class="section-title">Esthetics</h2>  Consistency. <br/></section><section id="section-Discussion" class="section"><h2 class="section-title">Discussion</h2>  None. </section></div></main><footer>Copyright © 2021 Jan Moringen</footer></body></html>