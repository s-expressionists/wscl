<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1 plus MathML 2.0//EN"
  "http://www.w3.org/Math/DTD/mathml2/xhtml-math11-f.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta charset="utf-8"/><link rel="stylesheet" type="text/css" href="../style.css"/><script src="../permalink.js"/><script src="../navigation.js"/><title>Well-specified Common Lisp — DECLARE-ARRAY-TYPE-ELEMENT-REFERENCES</title></head><body><main><nav class="sidebar"><span class="name">Entry Points</span><br/><ol><li><a href="../chap-0.xhtml#section-Figures">Table of Contents</a></li><li><a href="../symbol-index.xhtml#section-SymbolIndex">Symbol Index</a></li><li><a href="../figure-index.xhtml#section-FigureIndex">Figure Index</a></li><li><a href="../issue-index.xhtml#section-IssueIndices">Issue Index</a></li><li><a href="../note-indices.xhtml#section-ReviewerNoteIndex">Note Indices</a></li><li><a href="../chapter-26.xhtml#section-Glossary">Glossary</a></li></ol><hr/><span class="name">DECLARE-ARRAY-TYPE-ELEMENT-REFERENCES</span><br/><ol class="local-toc"><li><a href="#section-Status">Status</a><ol> </ol></li><li><a href="#section-References">References</a><ol> </ol></li><li><a href="#section-Edit history">Edit history</a><ol> </ol></li><li><a href="#section-Problem description">Problem description</a><ol> </ol></li><li><a href="#issue-declare-array-type-element-references:restrictive">Proposal RESTRICTIVE</a><ol> </ol></li><li><a href="#section-Examples">Examples</a><ol> </ol></li><li><a href="#section-Note that the above definition of FROB is equivalent to">Note that the above definition of FROB is equivalent to</a><ol> </ol></li><li><a href="#section-Test Cases">Test Cases</a><ol> </ol></li><li><a href="#section-Rationale">Rationale</a><ol> </ol></li><li><a href="#section-Current practice">Current practice</a><ol> </ol></li><li><a href="#section-Cost to Implementors">Cost to Implementors</a><ol> </ol></li><li><a href="#section-Cost to Users">Cost to Users</a><ol> </ol></li><li><a href="#section-Cost of non-adoption">Cost of non-adoption</a><ol> </ol></li><li><a href="#section-Performance impact">Performance impact</a><ol> </ol></li><li><a href="#section-Benefits">Benefits</a><ol> </ol></li><li><a href="#section-Aesthetics">Aesthetics</a><ol> </ol></li><li><a href="#section-Discussion">Discussion</a><ol> </ol></li></ol></nav><div class="content"><h1>X3J13 Issue DECLARE-ARRAY-TYPE-ELEMENT-REFERENCES [NIL] [CHANGE]</h1><h2>Related issues</h2><ul><a class="issue-reference" href="../issues/array-type-element-type-semantics.xhtml#issue-array-type-element-type-semantics">ARRAY-TYPE-ELEMENT-TYPE-SEMANTICS</a><span class="issue-reference error">issue:DECLARE-TYPE-FREE</span><a class="issue-reference" href="../issues/symbol-macrolet-declare.xhtml#issue-symbol-macrolet-declare">SYMBOL-MACROLET-DECLARE</a></ul><section id="section-Status" class="status-passed section"><h2 class="section-title">Status</h2>Passed, Jan 89 X3J13 </section><section id="section-References" class="section"><h2 class="section-title">References</h2>Array type specifiers, pp. 45-46 </section><section id="section-Edit history" class="section"><h2 class="section-title">Edit history</h2>Version 1,  7-Oct-88, Pierson Version 2, 13-Jan-89, Pierson (Moon and JonL comments) Version 3, 13-Jan-89, Pierson (Pitman comments) </section><section id="section-Problem description" class="section"><h2 class="section-title">Problem description</h2>In principle, array type specifiers could be used both for declaring the storage format of the array and for implicitly declaring the types of the elements held by those arrays. Unfortunately, the current  definition of the meaning of array type specifiers does not explicitly specify that the latter use of these declarations is legitimate. <br/></section><section class="status-passed proposal" id="issue-declare-array-type-element-references:restrictive"><h2 class="section-title">Proposal RESTRICTIVE</h2>Within the lexical scope of an array type declaration, all references to array elements are assumed to satisfy the exact declared element type.  It is an error if this is ever violated.  A compiler may treat the code within the scope of the array type declaration as if each access of an array element was surrounded by an appropriate <a class="special-operator-reference" href="../chapter-3.xhtml#special-operator-the">the</a> form. <br/></section><section id="section-Examples" class="section"><h2 class="section-title">Examples</h2><pre><code><span class="syntax-root"><span class="syntax-cons">(<a class="macro-reference" href="../chapter-5.xhtml#macro-defvar">defvar</a> <span class="syntax-interned-symbol">*ONE-ARRAY*</span> <span class="syntax-cons">(<a class="function-reference" href="../chapter-15.xhtml#function-make-array">make-array</a> <span class="syntax-number">10</span> <span class="syntax-keyword-symbol">:ELEMENT-TYPE</span> <span class="syntax-quote">'<span class="syntax-cons">(<a class="type-reference" href="../chapter-12.xhtml#type-signed-byte">signed-byte</a> <span class="syntax-number">5</span>)</span></span>)</span>)</span>
</span></code><br/><code><span class="syntax-root"><span class="syntax-cons">(<a class="macro-reference" href="../chapter-5.xhtml#macro-defvar">defvar</a> <span class="syntax-interned-symbol">*ANOTHER-ARRAY*</span> <span class="syntax-cons">(<a class="function-reference" href="../chapter-15.xhtml#function-make-array">make-array</a> <span class="syntax-number">10</span> <span class="syntax-keyword-symbol">:ELEMENT-TYPE</span> <span class="syntax-quote">'<span class="syntax-cons">(<a class="type-reference" href="../chapter-12.xhtml#type-signed-byte">signed-byte</a> <span class="syntax-number">8</span>)</span></span>)</span>)</span>
</span></code><br/><br/><pre><code><span class="syntax-root"><span class="syntax-cons">(<a class="macro-reference" href="../chapter-5.xhtml#macro-defun">defun</a> <span class="syntax-interned-symbol">FROB</span> <span class="syntax-cons">(<span class="syntax-interned-symbol">AN-ARRAY</span>)</span>
  <span class="syntax-cons">(<a class="symbol-reference" href="../chapter-3.xhtml#symbol-declare">declare</a> <span class="syntax-cons">(<a class="symbol-reference" href="../chapter-25.xhtml#symbol-type">type</a> <span class="syntax-cons">(<a class="symbol-reference" href="../chapter-2.xhtml#symbol-array">array</a> <span class="syntax-cons">(<a class="type-reference" href="../chapter-12.xhtml#type-signed-byte">signed-byte</a> <span class="syntax-number">5</span>)</span> <span class="syntax-number">1</span>)</span> <span class="syntax-interned-symbol">AN-ARRAY</span>)</span>)</span>
  <span class="syntax-cons">(<a class="macro-reference" href="../chapter-5.xhtml#macro-setf">setf</a> <span class="syntax-cons">(<a class="function-reference" href="../chapter-15.xhtml#function-aref">aref</a> <span class="syntax-interned-symbol">AN-ARRAY</span> <span class="syntax-number">1</span>)</span> <span class="syntax-number">31</span>)</span>		<span class="syntax-line-comment syntax-comment">; OK
</span>  <span class="syntax-cons">(<a class="macro-reference" href="../chapter-5.xhtml#macro-setf">setf</a> <span class="syntax-cons">(<a class="function-reference" href="../chapter-15.xhtml#function-aref">aref</a> <span class="syntax-interned-symbol">AN-ARRAY</span> <span class="syntax-number">2</span>)</span> <span class="syntax-number">127</span>)</span>		<span class="syntax-line-comment syntax-comment">; Should signal an error
</span>  <span class="syntax-cons">(<a class="macro-reference" href="../chapter-5.xhtml#macro-setf">setf</a> <span class="syntax-cons">(<a class="function-reference" href="../chapter-15.xhtml#function-aref">aref</a> <span class="syntax-interned-symbol">AN-ARRAY</span> <span class="syntax-number">3</span>)</span> <span class="syntax-cons">(<a class="function-reference" href="../chapter-12.xhtml#function-*">*</a> <span class="syntax-number">2</span> <span class="syntax-cons">(<a class="function-reference" href="../chapter-15.xhtml#function-aref">aref</a> <span class="syntax-interned-symbol">AN-ARRAY</span> <span class="syntax-number">3</span>)</span>)</span>)</span> <span class="syntax-line-comment syntax-comment">; Run-time decision needed
</span>  <span class="syntax-cons">(<a class="special-operator-reference" href="../chapter-5.xhtml#special-operator-let">let</a> <span class="syntax-cons">(<span class="syntax-cons">(<span class="syntax-interned-symbol">FOO</span> <span class="syntax-number">0</span>)</span>)</span>
    <span class="syntax-cons">(<a class="symbol-reference" href="../chapter-3.xhtml#symbol-declare">declare</a> <span class="syntax-cons">(<a class="symbol-reference" href="../chapter-25.xhtml#symbol-type">type</a> <span class="syntax-cons">(<a class="type-reference" href="../chapter-12.xhtml#type-signed-byte">signed-byte</a> <span class="syntax-number">5</span>)</span> <span class="syntax-interned-symbol">FOO</span>)</span>)</span>
    <span class="syntax-cons">(<a class="macro-reference" href="../chapter-5.xhtml#macro-setf">setf</a> <span class="syntax-interned-symbol">FOO</span> <span class="syntax-cons">(<a class="function-reference" href="../chapter-15.xhtml#function-aref">aref</a> <span class="syntax-interned-symbol">AN-ARRAY</span> <span class="syntax-number">0</span>)</span>)</span>)</span>)</span>
</span></code></pre>	; Declared to be safe<br/><br/><code><span class="syntax-root"><span class="syntax-cons">(<span class="syntax-interned-symbol">FROB</span> <span class="syntax-interned-symbol">*ONE-ARRAY*</span>)</span>
</span></code>			; Legal call, should signal an error<br/><code><span class="syntax-root"><span class="syntax-cons">(<span class="syntax-interned-symbol">FROM</span> <span class="syntax-interned-symbol">*ANOTHER-ARRAY*</span>)</span>
</span></code>			; Is probably an undetectable error<br/><br/></pre></section><section id="section-Note that the above definition of FROB is equivalent to" class="section"><h2 class="section-title">Note that the above definition of FROB is equivalent to</h2><pre><code><span class="syntax-root"><span class="syntax-cons">(<a class="macro-reference" href="../chapter-5.xhtml#macro-defun">defun</a> <span class="syntax-interned-symbol">FROB</span> <span class="syntax-cons">(<span class="syntax-interned-symbol">AN-ARRAY</span>)</span>
  <span class="syntax-cons">(<a class="symbol-reference" href="../chapter-3.xhtml#symbol-declare">declare</a> <span class="syntax-cons">(<a class="symbol-reference" href="../chapter-25.xhtml#symbol-type">type</a> <span class="syntax-cons">(<a class="symbol-reference" href="../chapter-2.xhtml#symbol-array">array</a> <span class="syntax-cons">(<a class="type-reference" href="../chapter-12.xhtml#type-signed-byte">signed-byte</a> <span class="syntax-number">5</span>)</span> <span class="syntax-number">1</span>)</span> <span class="syntax-interned-symbol">AN-ARRAY</span>)</span>)</span>
  <span class="syntax-cons">(<a class="macro-reference" href="../chapter-5.xhtml#macro-setf">setf</a> <span class="syntax-cons">(<a class="special-operator-reference" href="../chapter-3.xhtml#special-operator-the">the</a> <span class="syntax-cons">(<a class="type-reference" href="../chapter-12.xhtml#type-signed-byte">signed-byte</a> <span class="syntax-number">5</span>)</span> <span class="syntax-cons">(<a class="function-reference" href="../chapter-15.xhtml#function-aref">aref</a> <span class="syntax-interned-symbol">AN-ARRAY</span> <span class="syntax-number">1</span>)</span> <span class="syntax-number">31</span>)</span>)</span>
  <span class="syntax-cons">(<a class="macro-reference" href="../chapter-5.xhtml#macro-setf">setf</a> <span class="syntax-cons">(<a class="special-operator-reference" href="../chapter-3.xhtml#special-operator-the">the</a> <span class="syntax-cons">(<a class="type-reference" href="../chapter-12.xhtml#type-signed-byte">signed-byte</a> <span class="syntax-number">5</span>)</span> <span class="syntax-cons">(<a class="function-reference" href="../chapter-15.xhtml#function-aref">aref</a> <span class="syntax-interned-symbol">AN-ARRAY</span> <span class="syntax-number">2</span>)</span> <span class="syntax-number">127</span>)</span>)</span>
  <span class="syntax-cons">(<a class="macro-reference" href="../chapter-5.xhtml#macro-setf">setf</a> <span class="syntax-cons">(<a class="special-operator-reference" href="../chapter-3.xhtml#special-operator-the">the</a> <span class="syntax-cons">(<a class="type-reference" href="../chapter-12.xhtml#type-signed-byte">signed-byte</a> <span class="syntax-number">5</span>)</span> <span class="syntax-cons">(<a class="function-reference" href="../chapter-15.xhtml#function-aref">aref</a> <span class="syntax-interned-symbol">AN-ARRAY</span> <span class="syntax-number">3</span>)</span>)</span>
	<span class="syntax-cons">(<a class="function-reference" href="../chapter-12.xhtml#function-*">*</a> <span class="syntax-number">2</span> <span class="syntax-cons">(<a class="special-operator-reference" href="../chapter-3.xhtml#special-operator-the">the</a> <span class="syntax-cons">(<a class="type-reference" href="../chapter-12.xhtml#type-signed-byte">signed-byte</a> <span class="syntax-number">5</span>)</span> <span class="syntax-cons">(<a class="function-reference" href="../chapter-15.xhtml#function-aref">aref</a> <span class="syntax-interned-symbol">AN-ARRAY</span> <span class="syntax-number">3</span>)</span>)</span>)</span>)</span>
  <span class="syntax-cons">(<a class="special-operator-reference" href="../chapter-5.xhtml#special-operator-let">let</a> <span class="syntax-cons">(<span class="syntax-cons">(<span class="syntax-interned-symbol">FOO</span> <span class="syntax-number">0</span>)</span>)</span>
    <span class="syntax-cons">(<a class="symbol-reference" href="../chapter-3.xhtml#symbol-declare">declare</a> <span class="syntax-cons">(<a class="symbol-reference" href="../chapter-25.xhtml#symbol-type">type</a> <span class="syntax-cons">(<a class="type-reference" href="../chapter-12.xhtml#type-signed-byte">signed-byte</a> <span class="syntax-number">5</span>)</span> <span class="syntax-interned-symbol">FOO</span>)</span>)</span>
    <span class="syntax-cons">(<a class="macro-reference" href="../chapter-5.xhtml#macro-setf">setf</a> <span class="syntax-interned-symbol">FOO</span> <span class="syntax-cons">(<a class="special-operator-reference" href="../chapter-3.xhtml#special-operator-the">the</a> <span class="syntax-cons">(<a class="type-reference" href="../chapter-12.xhtml#type-signed-byte">signed-byte</a> <span class="syntax-number">5</span>)</span> <span class="syntax-cons">(<a class="function-reference" href="../chapter-15.xhtml#function-aref">aref</a> <span class="syntax-interned-symbol">AN-ARRAY</span> <span class="syntax-number">0</span>)</span>)</span>)</span>)</span>)</span>
</span></code></pre> <br/>Given an implementation in which fixnums are 29 bits but fixnum arrays are upgraded to signed 32-bit arrays, the following should be compiled with all fixnum arithmetic: <br/><pre><code><span class="syntax-root"><span class="syntax-cons">(<a class="macro-reference" href="../chapter-5.xhtml#macro-defun">defun</a> <span class="syntax-interned-symbol">BUMP-COUNTERS</span> <span class="syntax-cons">(<span class="syntax-interned-symbol">COUNTERS</span>)</span>
  <span class="syntax-cons">(<a class="symbol-reference" href="../chapter-3.xhtml#symbol-declare">declare</a> <span class="syntax-cons">(<a class="symbol-reference" href="../chapter-25.xhtml#symbol-type">type</a> <span class="syntax-cons">(<a class="symbol-reference" href="../chapter-2.xhtml#symbol-array">array</a> <a class="type-reference" href="../chapter-12.xhtml#type-fixnum">fixnum</a> <a class="function-reference" href="../chapter-12.xhtml#function-*">*</a>)</span> <span class="syntax-interned-symbol">BUMP-COUNTERS</span>)</span>)</span>
  <span class="syntax-cons">(<a class="macro-reference" href="../chapter-6.xhtml#macro-dotimes">dotimes</a> <span class="syntax-cons">(<span class="syntax-interned-symbol">I</span> <span class="syntax-cons">(<a class="function-reference" href="../chapter-17.xhtml#function-length">length</a> <span class="syntax-interned-symbol">COUNTERS</span>)</span>)</span>
    <span class="syntax-cons">(<a class="macro-reference" href="../chapter-12.xhtml#macro-incf">incf</a> <span class="syntax-cons">(<a class="function-reference" href="../chapter-15.xhtml#function-aref">aref</a> <span class="syntax-interned-symbol">COUNTERS</span> <span class="syntax-interned-symbol">I</span>)</span>)</span>)</span>)</span>
</span></code></pre> <br/></section><section id="section-Test Cases" class="section"><h2 class="section-title">Test Cases</h2><pre>TBS<br/><br/></pre></section><section id="section-Rationale" class="section"><h2 class="section-title">Rationale</h2>This mandates a useful and commonly expected behavior.  It complements proposal <a class="issue-reference" href="../issues/array-type-element-type-semantics.xhtml#issue-array-type-element-type-semantics">array-type-element-type-semantics</a>, which deals with array type specifiers as they refer to arrays as a whole.   <br/>This proposal is consistent with <a class="issue-reference" href="../issues/symbol-macrolet-declare.xhtml#issue-symbol-macrolet-declare:allow">SYMBOL-MACROLET-DECLARE:ALLOW</a> and <span class="issue-reference error">issue:DECLARATION-SCOPE:LEXICAL</span>. <br/></section><section id="section-Current practice" class="section"><h2 class="section-title">Current practice</h2>??? <br/></section><section id="section-Cost to Implementors" class="section"><h2 class="section-title">Cost to Implementors</h2>TBS <br/></section><section id="section-Cost to Users" class="section"><h2 class="section-title">Cost to Users</h2>Probably none; while this is technically a change, code that declares an array to contain one thing and depends on it containing something else is blatantly buggy. <br/></section><section id="section-Cost of non-adoption" class="section"><h2 class="section-title">Cost of non-adoption</h2>Users will continue to expect declaration syntax to be more useful than it really is. <br/></section><section id="section-Performance impact" class="section"><h2 class="section-title">Performance impact</h2>None. <br/></section><section id="section-Benefits" class="section"><h2 class="section-title">Benefits</h2>Array type declarations will behave in a more useful and intuitive way. <br/></section><section id="section-Aesthetics" class="section"><h2 class="section-title">Aesthetics</h2>Improved because the meaning of type declarations will coincide more clearly with their appearance. <br/></section><section id="section-Discussion" class="section"><h2 class="section-title">Discussion</h2>Pierson and Pitman support this proposal. </section></div></main><footer>Copyright © 2021 Jan Moringen</footer></body></html>