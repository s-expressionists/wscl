<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1 plus MathML 2.0//EN"
  "http://www.w3.org/Math/DTD/mathml2/xhtml-math11-f.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta charset="utf-8"/><link rel="stylesheet" type="text/css" href="../style.css"/><script src="../permalink.js"/><script src="../navigation.js"/><title>Well-specified Common Lisp — FLET-DECLARATIONS</title></head><body><main><nav class="sidebar"><span class="name">Entry Points</span><br/><ol><li><a href="../chap-0.xhtml#section-Figures">Table of Contents</a></li><li><a href="../symbol-index.xhtml#section-SymbolIndex">Symbol Index</a></li><li><a href="../figure-index.xhtml#section-FigureIndex">Figure Index</a></li><li><a href="../issue-index.xhtml#section-IssueIndices">Issue Index</a></li><li><a href="../note-indices.xhtml#section-ReviewerNoteIndex">Note Indices</a></li><li><a href="../chapter-26.xhtml#section-Glossary">Glossary</a></li></ol><hr/><span class="name">FLET-DECLARATIONS</span><br/><ol class="local-toc"><li><a href="#section-Status">Status</a><ol> </ol></li><li><a href="#section-References">References</a><ol> </ol></li><li><a href="#section-Edit history">Edit history</a><ol> </ol></li><li><a href="#section-Problem description">Problem description</a><ol> </ol></li><li><a href="#issue-flet-declarations:allow">Proposal ALLOW</a><ol> </ol></li><li><a href="#section-Example">Example</a><ol> </ol></li><li><a href="#section-Rationale">Rationale</a><ol> </ol></li><li><a href="#section-Current practice">Current practice</a><ol> </ol></li><li><a href="#section-Cost to Implementors">Cost to Implementors</a><ol> </ol></li><li><a href="#section-Cost to Users">Cost to Users</a><ol> </ol></li><li><a href="#section-Cost of non-adoption">Cost of non-adoption</a><ol> </ol></li><li><a href="#section-Benefits">Benefits</a><ol> </ol></li><li><a href="#section-Esthetics">Esthetics</a><ol> </ol></li><li><a href="#section-Discussion">Discussion</a><ol> </ol></li></ol></nav><div class="content"><h1>X3J13 Issue FLET-DECLARATIONS [NIL] [ADDITION]</h1><section id="section-Status" class="status-passed section"><h2 class="section-title">Status</h2>Passed, March 88 </section><section id="section-References" class="section"><h2 class="section-title">References</h2><a class="special-operator-reference" href="../chapter-5.xhtml#special-operator-flet">FLET</a>, <a class="special-operator-reference" href="../chapter-5.xhtml#special-operator-labels">LABELS</a>, <a class="special-operator-reference" href="../chapter-5.xhtml#special-operator-macrolet">MACROLET</a> (CLtL p.113) X3J13 document 86-003 item 113 Cleanup <a class="issue-reference" href="../issues/declaration-scope.xhtml#issue-declaration-scope">X3J13 Issue DECLARATION-SCOPE</a>. Cleanup <span class="issue-reference error">issue:DECLARE-MACROS</span>. </section><section id="section-Edit history" class="section"><h2 class="section-title">Edit history</h2>Version 1, Moon, 1 Jan 1988 Version 2, Moon, 2 Feb 1988 (edits suggested by Masinter) </section><section id="section-Problem description" class="section"><h2 class="section-title">Problem description</h2>Declarations are not allowed before the body of <a class="special-operator-reference" href="../chapter-5.xhtml#special-operator-flet">FLET</a>, <a class="special-operator-reference" href="../chapter-5.xhtml#special-operator-labels">LABELS</a>, and <a class="special-operator-reference" href="../chapter-5.xhtml#special-operator-macrolet">MACROLET</a>, even though Common Lisp allows declarations in other seemingly analogous places, such as <a class="special-operator-reference" href="../chapter-5.xhtml#special-operator-let">LET</a>. <br/></section><section class="status-passed proposal" id="issue-flet-declarations:allow"><h2 class="section-title">Proposal ALLOW</h2>Change the syntax of <a class="special-operator-reference" href="../chapter-5.xhtml#special-operator-flet">FLET</a>, <a class="special-operator-reference" href="../chapter-5.xhtml#special-operator-labels">LABELS</a>, and <a class="special-operator-reference" href="../chapter-5.xhtml#special-operator-macrolet">MACROLET</a> to allow declarations between the list of local function/macro definitions and the body forms. <br/>The scope of such declarations in <a class="special-operator-reference" href="../chapter-5.xhtml#special-operator-flet">FLET</a> and <a class="special-operator-reference" href="../chapter-5.xhtml#special-operator-labels">LABELS</a> includes the bodies of the locally defined functions, when the declarations are pervasive. Non-pervasive declarations have no effect on those bodies, except when <a class="special-operator-reference" href="../chapter-5.xhtml#special-operator-labels">LABELS</a> includes the body in the scope of a function non-pervasively declared.  This paragraph follows directly from CLtL p.155 if the locally defined function bodies are treated like initialization forms. (This paragraph will be superseded by cleanup <a class="issue-reference" href="../issues/declaration-scope.xhtml#issue-declaration-scope">X3J13 Issue DECLARATION-SCOPE</a> if it passes.) <br/>The scope of such declarations does not include the bodies of the macro expander functions defined by <a class="special-operator-reference" href="../chapter-5.xhtml#special-operator-macrolet">MACROLET</a>.  This is consistent with the existing rule that the bodies of those functions are in the global environment, not the local lexical environment. <br/>If cleanup <span class="issue-reference error">issue:DECLARE-MACROS</span> is not passed, in <a class="special-operator-reference" href="../chapter-5.xhtml#special-operator-macrolet">MACROLET</a> an invocation of one of the macros locally defined by that <a class="special-operator-reference" href="../chapter-5.xhtml#special-operator-macrolet">MACROLET</a> is permitted to expand into a <a class="symbol-reference" href="../chapter-3.xhtml#symbol-declare">DECLARE</a>. <br/></section><section id="section-Example" class="section"><h2 class="section-title">Example</h2><pre><pre><code><span class="syntax-root"><span class="syntax-cons">(<a class="macro-reference" href="../chapter-5.xhtml#macro-defun">defun</a> <span class="syntax-interned-symbol">example</span> <span class="syntax-cons">(<span class="syntax-interned-symbol">y</span> <span class="syntax-interned-symbol">l</span>)</span>
  <span class="syntax-cons">(<a class="special-operator-reference" href="../chapter-5.xhtml#special-operator-flet">flet</a> <span class="syntax-cons">(<span class="syntax-cons">(<span class="syntax-interned-symbol">attach</span> <span class="syntax-cons">(<span class="syntax-interned-symbol">x</span>)</span>
	   <span class="syntax-cons">(<a class="special-operator-reference" href="../chapter-5.xhtml#special-operator-setq">setq</a> <span class="syntax-interned-symbol">l</span> <span class="syntax-cons">(<a class="function-reference" href="../chapter-14.xhtml#function-append">append</a> <span class="syntax-interned-symbol">l</span> <span class="syntax-cons">(<a class="function-reference" href="../chapter-14.xhtml#function-list">list</a> <span class="syntax-interned-symbol">x</span>)</span>)</span>)</span>)</span>)</span>
    <span class="syntax-cons">(<a class="symbol-reference" href="../chapter-3.xhtml#symbol-declare">declare</a> <span class="syntax-cons">(<a class="declaration-reference" href="../chapter-3.xhtml#declaration-inline">inline</a> <span class="syntax-interned-symbol">attach</span>)</span>)</span>
    <span class="syntax-cons">(<a class="macro-reference" href="../chapter-6.xhtml#macro-dolist">dolist</a> <span class="syntax-cons">(<span class="syntax-interned-symbol">x</span> <span class="syntax-interned-symbol">y</span>)</span>
      <span class="syntax-cons">(<a class="macro-reference" href="../chapter-5.xhtml#macro-unless">unless</a> <span class="syntax-cons">(<a class="function-reference" href="../chapter-14.xhtml#function-null">null</a> <span class="syntax-cons">(<a class="function-reference" href="../chapter-14.xhtml#function-cdr">cdr</a> <span class="syntax-interned-symbol">x</span>)</span>)</span>
	<span class="syntax-cons">(<span class="syntax-interned-symbol">attach</span> <span class="syntax-interned-symbol">x</span>)</span>)</span>)</span>
    <span class="syntax-interned-symbol">l</span>)</span>)</span>
</span></code></pre><br/><br/><pre><code><span class="syntax-root"><span class="syntax-cons">(<span class="syntax-interned-symbol">example</span> <span class="syntax-quote">'<span class="syntax-cons">(<span class="syntax-cons">(<span class="syntax-interned-symbol">a</span> <span class="syntax-interned-symbol">apple</span> <span class="syntax-interned-symbol">apricot</span>)</span> <span class="syntax-cons">(<span class="syntax-interned-symbol">b</span> <span class="syntax-interned-symbol">banana</span>)</span> <span class="syntax-cons">(<span class="syntax-interned-symbol">c</span> <span class="syntax-interned-symbol">cherry</span>)</span> <span class="syntax-cons">(<span class="syntax-interned-symbol">d</span>)</span> <span class="syntax-cons">(<span class="syntax-interned-symbol">e</span>)</span>)</span></span>
	 <span class="syntax-quote">'<span class="syntax-cons">(<span class="syntax-cons">(<span class="syntax-number">1</span>)</span> <span class="syntax-cons">(<span class="syntax-number">2</span>)</span> <span class="syntax-cons">(<span class="syntax-number">3</span>)</span> <span class="syntax-cons">(<span class="syntax-number">4</span> <span class="syntax-number">2</span>)</span> <span class="syntax-cons">(<span class="syntax-number">5</span>)</span> <span class="syntax-cons">(<span class="syntax-number">6</span> <span class="syntax-number">3</span> <span class="syntax-number">2</span>)</span>)</span></span>)</span>
</span></code></pre><br/> <a class="function-reference" href="../chapter-12.xhtml#function-=">=</a>&gt; <code><span class="syntax-root"><span class="syntax-cons">(<span class="syntax-cons">(<span class="syntax-number">1</span>)</span> <span class="syntax-cons">(<span class="syntax-number">2</span>)</span> <span class="syntax-cons">(<span class="syntax-number">3</span>)</span> <span class="syntax-cons">(<span class="syntax-number">4</span> <span class="syntax-number">2</span>)</span> <span class="syntax-cons">(<span class="syntax-number">5</span>)</span> <span class="syntax-cons">(<span class="syntax-number">6</span> <span class="syntax-number">3</span> <span class="syntax-number">2</span>)</span> <span class="syntax-cons">(<span class="syntax-interned-symbol">a</span> <span class="syntax-interned-symbol">apple</span> <span class="syntax-interned-symbol">apricot</span>)</span> <span class="syntax-cons">(<span class="syntax-interned-symbol">b</span> <span class="syntax-interned-symbol">banana</span>)</span> <span class="syntax-cons">(<span class="syntax-interned-symbol">c</span> <span class="syntax-interned-symbol">cherry</span>)</span>)</span>
</span></code><br/><br/>The above function is erroneous in current Common Lisp.  With this proposal, it would have an intuitively obvious meaning.<br/><br/></pre></section><section id="section-Rationale" class="section"><h2 class="section-title">Rationale</h2>This will make the syntax of <a class="special-operator-reference" href="../chapter-5.xhtml#special-operator-flet">FLET</a> and <a class="special-operator-reference" href="../chapter-5.xhtml#special-operator-let">LET</a> consistent.  This will make it possible to attach declarations to function bindings; currently only variable bindings can have attached declarations. <br/></section><section id="section-Current practice" class="section"><h2 class="section-title">Current practice</h2>Xerox Common Lisp implements <a class="issue-reference" href="#issue-flet-declarations:allow">FLET-DECLARATIONS:ALLOW</a>. Symbolics Common Lisp does not allow declarations in this position. <br/></section><section id="section-Cost to Implementors" class="section"><h2 class="section-title">Cost to Implementors</h2>The compilation and interpretation of three special forms will have to be changed, however the same techniques already developed for declarations in <a class="special-operator-reference" href="../chapter-5.xhtml#special-operator-let">LET</a> should be applicable. <br/></section><section id="section-Cost to Users" class="section"><h2 class="section-title">Cost to Users</h2>No cost since this is an upward-compatible addition. <br/></section><section id="section-Cost of non-adoption" class="section"><h2 class="section-title">Cost of non-adoption</h2>Unnecessary inconsistency in the syntax of Common Lisp. <br/></section><section id="section-Benefits" class="section"><h2 class="section-title">Benefits</h2>There is no major benefit but the language will be more consistent. <br/></section><section id="section-Esthetics" class="section"><h2 class="section-title">Esthetics</h2>Makes the language more consistent. <br/></section><section id="section-Discussion" class="section"><h2 class="section-title">Discussion</h2>We need to resolve this for CLOS, because CLOS introduces two new special forms similar to <a class="special-operator-reference" href="../chapter-5.xhtml#special-operator-flet">FLET</a> and <a class="special-operator-reference" href="../chapter-5.xhtml#special-operator-labels">LABELS</a> and we need to make their syntax consistent with <a class="special-operator-reference" href="../chapter-5.xhtml#special-operator-flet">FLET</a> and <a class="special-operator-reference" href="../chapter-5.xhtml#special-operator-labels">LABELS</a>. <br/></section></div></main><footer>Copyright © 2021 Jan Moringen</footer></body></html>