<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1 plus MathML 2.0//EN"
  "http://www.w3.org/Math/DTD/mathml2/xhtml-math11-f.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta charset="utf-8"/><link rel="stylesheet" type="text/css" href="../style.css"/><script src="../permalink.js"/><script src="../navigation.js"/><title>Well-specified Common Lisp — HASH-TABLE-TESTS</title></head><body><main><nav class="sidebar"><span class="name">Entry Points</span><br/><ol><li><a href="../chap-0.xhtml#section-Figures">Table of Contents</a></li><li><a href="../symbol-index.xhtml#section-SymbolIndex">Symbol Index</a></li><li><a href="../figure-index.xhtml#section-FigureIndex">Figure Index</a></li><li><a href="../issue-index.xhtml#section-IssueIndices">Issue Index</a></li><li><a href="../note-indices.xhtml#section-ReviewerNoteIndex">Note Indices</a></li><li><a href="../chapter-26.xhtml#section-Glossary">Glossary</a></li></ol><hr/><span class="name">HASH-TABLE-TESTS</span><br/><ol class="local-toc"><li><a href="#section-Status">Status</a><ol> </ol></li><li><a href="#section-References">References</a><ol> </ol></li><li><a href="#section-Edit history">Edit history</a><ol> </ol></li><li><a href="#section-Problem Description">Problem Description</a><ol> </ol></li><li><a href="#issue-hash-table-tests:add-equalp">Proposal ADD-EQUALP</a><ol> </ol></li><li><a href="#section-Examples">Examples</a><ol> </ol></li><li><a href="#section-Rationale">Rationale</a><ol> </ol></li><li><a href="#section-Current Practice">Current Practice</a><ol> </ol></li><li><a href="#section-Cost to Implementors">Cost to Implementors</a><ol> </ol></li><li><a href="#section-Cost to Users">Cost to Users</a><ol> </ol></li><li><a href="#section-Cost of non-adoption">Cost of non-adoption</a><ol> </ol></li><li><a href="#section-Benefits">Benefits</a><ol> </ol></li><li><a href="#section-Aesthetics">Aesthetics</a><ol> </ol></li><li><a href="#section-Discussion">Discussion</a><ol> </ol></li></ol></nav><div class="content"><h1>X3J13 Issue HASH-TABLE-TESTS [NIL] [Addition]</h1><h2>Required issues</h2><ul><li><a class="issue-reference" href="../issues/contagion-on-numerical-comparisons.xhtml#issue-contagion-on-numerical-comparisons">CONTAGION-ON-NUMERICAL-COMPARISONS</a></li></ul><section id="section-Status" class="status-passed section"><h2 class="section-title">Status</h2>Passed, Jan 89 X3J13 </section><section id="section-References" class="section"><h2 class="section-title">References</h2>CLtL, p382 (third paragraph), and p383 <a class="issue-reference" href="../issues/equal-structure.xhtml#issue-equal-structure">X3J13 Issue EQUAL-STRUCTURE</a> </section><section id="section-Edit history" class="section"><h2 class="section-title">Edit history</h2>26-Sep-88 Version 1 by JonL 8-Dec-88 Version 2 by Masinter </section><section id="section-Problem Description" class="section"><h2 class="section-title">Problem Description</h2>A great many users try to coalesce two equivalent <a class="macro-reference" href="../chapter-8.xhtml#macro-defstruct">DEFSTRUCT</a> instances, or two equivalent pointer arrays, using hash tables; but they are rudely awakened when they find out that <a class="function-reference" href="../chapter-5.xhtml#function-equal">EQUAL</a> is not an appropriate test for this case, and that there is no :test argument to <a class="function-reference" href="../chapter-18.xhtml#function-make-hash-table">MAKE-HASH-TABLE</a> which  will "hash on non-tree structures". <br/></section><section class="status-passed proposal" id="issue-hash-table-tests:add-equalp"><h2 class="section-title">Proposal ADD-EQUALP</h2>With the advent of the <a class="issue-reference" href="../issues/contagion-on-numerical-comparisons.xhtml#issue-contagion-on-numerical-comparisons">X3J13 Issue CONTAGION-ON-NUMERICAL-COMPARISONS</a>, we can expect <a class="function-reference" href="../chapter-5.xhtml#function-equalp">EQUALP</a> to be a true equivalence function, and thus a suitable candidate for the :test function to <a class="function-reference" href="../chapter-18.xhtml#function-make-hash-table">MAKE-HASH-TABLE</a>.   Hash-tables will  come in four kinds, the difference being whether the keys are compared  with <a class="function-reference" href="../chapter-5.xhtml#function-eq">EQ</a>, <a class="function-reference" href="../chapter-5.xhtml#function-eql">EQL</a>, <a class="function-reference" href="../chapter-5.xhtml#function-equal">EQUAL</a>, or <a class="function-reference" href="../chapter-5.xhtml#function-equalp">EQUALP</a>. <br/></section><section id="section-Examples" class="section"><h2 class="section-title">Examples</h2><pre>&gt; <code><span class="syntax-root"><span class="syntax-cons">(<a class="macro-reference" href="../chapter-8.xhtml#macro-defstruct">defstruct</a> <span class="syntax-interned-symbol">foo</span> <span class="syntax-interned-symbol">a</span> <span class="syntax-interned-symbol">b</span> <span class="syntax-interned-symbol">c</span>)</span>
</span></code><br/><a class="index/code-reference" href="../chapter-1.xhtml#index/code-foo">FOO</a><br/>&gt; <pre><code><span class="syntax-root"><span class="syntax-cons">(<a class="special-operator-reference" href="../chapter-5.xhtml#special-operator-setq">setq</a> <span class="syntax-interned-symbol">x</span>      <span class="syntax-cons">(<span class="syntax-interned-symbol">make-foo</span> <span class="syntax-keyword-symbol">:a</span> <span class="syntax-number">1</span> <span class="syntax-keyword-symbol">:b</span> <span class="syntax-quote">'<span class="syntax-interned-symbol">b</span></span> <span class="syntax-keyword-symbol">:c</span> <span class="syntax-quote">'<span class="syntax-cons">(<span class="syntax-number">1</span> <span class="syntax-symbol">.</span> <span class="syntax-number">2</span>)</span></span>)</span>
        <span class="syntax-interned-symbol">x-copy</span> <span class="syntax-cons">(<span class="syntax-interned-symbol">make-foo</span> <span class="syntax-keyword-symbol">:a</span> <span class="syntax-number">1</span> <span class="syntax-keyword-symbol">:b</span> <span class="syntax-quote">'<span class="syntax-interned-symbol">b</span></span> <span class="syntax-keyword-symbol">:c</span> <span class="syntax-quote">'<span class="syntax-cons">(<span class="syntax-number">1</span> <span class="syntax-symbol">.</span> <span class="syntax-number">2</span>)</span></span>)</span>)</span>
</span></code></pre><br/>#S<code><span class="syntax-root"><span class="syntax-cons">(<span class="syntax-interned-symbol">FOO</span> <span class="syntax-interned-symbol">A</span> <span class="syntax-number">1</span> <span class="syntax-interned-symbol">B</span> <span class="syntax-interned-symbol">B</span> <span class="syntax-interned-symbol">C</span> <span class="syntax-cons">(<span class="syntax-number">1</span> <span class="syntax-symbol">.</span> <span class="syntax-number">2</span>)</span>)</span>
</span></code><br/>&gt; <pre><code><span class="syntax-root"><span class="syntax-cons">(<a class="special-operator-reference" href="../chapter-5.xhtml#special-operator-setq">setq</a> <span class="syntax-interned-symbol">y</span>      <span class="syntax-vector">#(<span class="syntax-number">1</span> <span class="syntax-interned-symbol">B</span> <span class="syntax-cons">(<span class="syntax-number">1</span> <span class="syntax-symbol">.</span> <span class="syntax-number">2</span>)</span>)</span>
        <span class="syntax-interned-symbol">y-copy</span> <span class="syntax-cons">(<a class="function-reference" href="../chapter-17.xhtml#function-copy-seq">copy-seq</a> <span class="syntax-interned-symbol">y</span>)</span>)</span>
</span></code></pre><br/>#<code><span class="syntax-root"><span class="syntax-cons">(<span class="syntax-number">1</span> <span class="syntax-interned-symbol">B</span> <span class="syntax-cons">(<span class="syntax-number">1</span> <span class="syntax-symbol">.</span> <span class="syntax-number">2</span>)</span>)</span>
</span></code><br/>&gt; <pre><code><span class="syntax-root"><span class="syntax-cons">(<a class="special-operator-reference" href="../chapter-5.xhtml#special-operator-setq">setq</a> <span class="syntax-interned-symbol">ht-equal</span>  <span class="syntax-cons">(<a class="function-reference" href="../chapter-18.xhtml#function-make-hash-table">make-hash-table</a> <span class="syntax-keyword-symbol">:test</span> <span class="syntax-quote">'<a class="function-reference" href="../chapter-5.xhtml#function-equal">equal</a></span>)</span> 
        <span class="syntax-interned-symbol">ht-equalp</span> <span class="syntax-cons">(<a class="function-reference" href="../chapter-18.xhtml#function-make-hash-table">make-hash-table</a> <span class="syntax-keyword-symbol">:test</span> <span class="syntax-quote">'<a class="function-reference" href="../chapter-5.xhtml#function-equalp">equalp</a></span>)</span>)</span>
</span></code></pre><br/><br/>#&lt;<a class="type-reference" href="../chapter-18.xhtml#type-hash-table">Hash-Table</a> BB1F7B&gt;<br/>&gt; <pre><code><span class="syntax-root"><span class="syntax-cons">(<a class="special-operator-reference" href="../chapter-5.xhtml#special-operator-progn">progn</a> <span class="syntax-cons">(<a class="macro-reference" href="../chapter-5.xhtml#macro-setf">setf</a> <span class="syntax-cons">(<a class="function-reference" href="../chapter-18.xhtml#function-gethash">gethash</a> <span class="syntax-interned-symbol">x</span> <span class="syntax-interned-symbol">ht-equal</span>)</span> <a class="section-reference" href="../chapter-26.xhtml#section-T">t</a>)</span> <span class="syntax-cons">(<a class="macro-reference" href="../chapter-5.xhtml#macro-setf">setf</a> <span class="syntax-cons">(<a class="function-reference" href="../chapter-18.xhtml#function-gethash">gethash</a> <span class="syntax-interned-symbol">x</span> <span class="syntax-interned-symbol">ht-equalp</span>)</span> <a class="section-reference" href="../chapter-26.xhtml#section-T">t</a>)</span> 
         <span class="syntax-cons">(<a class="macro-reference" href="../chapter-5.xhtml#macro-setf">setf</a> <span class="syntax-cons">(<a class="function-reference" href="../chapter-18.xhtml#function-gethash">gethash</a> <span class="syntax-interned-symbol">y</span> <span class="syntax-interned-symbol">ht-equal</span>)</span> <a class="section-reference" href="../chapter-26.xhtml#section-T">t</a>)</span> <span class="syntax-cons">(<a class="macro-reference" href="../chapter-5.xhtml#macro-setf">setf</a> <span class="syntax-cons">(<a class="function-reference" href="../chapter-18.xhtml#function-gethash">gethash</a> <span class="syntax-interned-symbol">y</span> <span class="syntax-interned-symbol">ht-equalp</span>)</span> <a class="section-reference" href="../chapter-26.xhtml#section-T">t</a>)</span>)</span>
</span></code></pre><br/><a class="section-reference" href="../chapter-26.xhtml#section-T">T</a><br/>&gt; <code><span class="syntax-root"><span class="syntax-cons">(<a class="function-reference" href="../chapter-18.xhtml#function-gethash">gethash</a> <span class="syntax-interned-symbol">x-copy</span> <span class="syntax-interned-symbol">ht-equal</span>)</span>
</span></code><br/><a class="section-reference" href="../chapter-1.xhtml#section-NIL">NIL</a><br/><a class="section-reference" href="../chapter-1.xhtml#section-NIL">NIL</a><br/>&gt; <code><span class="syntax-root"><span class="syntax-cons">(<a class="function-reference" href="../chapter-18.xhtml#function-gethash">gethash</a> <span class="syntax-interned-symbol">x-copy</span> <span class="syntax-interned-symbol">ht-equalp</span>)</span>
</span></code><br/><a class="section-reference" href="../chapter-26.xhtml#section-T">T</a><br/><a class="section-reference" href="../chapter-26.xhtml#section-T">T</a><br/>&gt; <code><span class="syntax-root"><span class="syntax-cons">(<a class="function-reference" href="../chapter-18.xhtml#function-gethash">gethash</a> <span class="syntax-interned-symbol">y-copy</span> <span class="syntax-interned-symbol">ht-equal</span>)</span>
</span></code><br/><a class="section-reference" href="../chapter-1.xhtml#section-NIL">NIL</a><br/><a class="section-reference" href="../chapter-1.xhtml#section-NIL">NIL</a><br/>&gt; <code><span class="syntax-root"><span class="syntax-cons">(<a class="function-reference" href="../chapter-18.xhtml#function-gethash">gethash</a> <span class="syntax-cons">(<a class="function-reference" href="../chapter-17.xhtml#function-copy-seq">copy-seq</a> <span class="syntax-interned-symbol">y</span>)</span> <span class="syntax-interned-symbol">ht-equalp</span>)</span>
</span></code><br/><a class="section-reference" href="../chapter-26.xhtml#section-T">T</a><br/><a class="section-reference" href="../chapter-26.xhtml#section-T">T</a><br/>&gt; <br/><br/></pre></section><section id="section-Rationale" class="section"><h2 class="section-title">Rationale</h2>Implementing hash-tables efficiently is not an easy task; it makes more sense for this to be standardly available than for individual programmers  to keep trying to re-invent this obscure part of technology. <br/></section><section id="section-Current Practice" class="section"><h2 class="section-title">Current Practice</h2>Lucid's release 3.0 implements this proposal [some 2.1-level release supported it "provisionally"].  Symbolics implementation is reputed to be robust enough to implement this proposal trivially. <br/></section><section id="section-Cost to Implementors" class="section"><h2 class="section-title">Cost to Implementors</h2>Moderate.  Implementors have already dealt with <a class="function-reference" href="../chapter-5.xhtml#function-equal">EQUAL</a>; the only tricky  part will be ensuring the implication:     "If 'a' is <a class="function-reference" href="../chapter-5.xhtml#function-equalp">EQUALP</a> to 'b', then 'a' and 'b' must lie in the      same collision chain in any given <a class="function-reference" href="../chapter-5.xhtml#function-equalp">EQUALP</a> hash table" It has been suggested that merely linear searching a table is an acceptable implementation technique for <a class="package-reference" href="../chapter-11.xhtml#package-cl">CL</a>'s hash-tables  [although no serious  implementation limits itself thus] and that such tables have no "collision  chains"; but in fact, this is the degenerate case wherein all entries are  in the same collision chain, so the implication is trivially satisfied. <br/>Some persons prefer to say that the "reprobe sequence will be the same for the two items", rather than using the term "collision chain"; the meaning  is the same.  <br/><br/></section><section id="section-Cost to Users" class="section"><h2 class="section-title">Cost to Users</h2>None.  This is an entirely upwards-compatible addition. <br/></section><section id="section-Cost of non-adoption" class="section"><h2 class="section-title">Cost of non-adoption</h2>Continuing bug reports from users  about why "hashing  doesn't work" when said user tries entering pointer-containing objects other than cons cells into hash tables.  Continuing delay in same user's work until they figure out a new strategy for identifying equivalent structures.  More difficulty in debugging their alternatives. <br/></section><section id="section-Benefits" class="section"><h2 class="section-title">Benefits</h2>Addresses one aspect of the difficult equivalence problem.  Makes hash tables more useful.  Permits case-insensitive hashing on strings [tables of type <a class="function-reference" href="../chapter-5.xhtml#function-equal">EQUAL</a> are case-sensitive on strings];  another use is to allow <a class="function-reference" href="../chapter-12.xhtml#function-=">=</a> comparison for numbers  [tables of type <a class="function-reference" href="../chapter-5.xhtml#function-equal">EQUAL</a> use <a class="function-reference" href="../chapter-5.xhtml#function-eql">EQL</a> on numbers]. <br/></section><section id="section-Aesthetics" class="section"><h2 class="section-title">Aesthetics</h2>Reduces the discontinuity between basic equivalence functions and those usable as equivalence relations in hash-tables. <br/></section><section id="section-Discussion" class="section"><h2 class="section-title">Discussion</h2>With the rejection of all the issues related to <a class="issue-reference" href="../issues/equal-structure.xhtml#issue-equal-structure">EQUAL-STRUCTURE</a>, there is  little or no hope that <a class="function-reference" href="../chapter-5.xhtml#function-equal">EQUAL</a> will be "beefed up" to meet the expectations of so many of the user community on compound structures.   If one wants a <a class="type-reference" href="../chapter-18.xhtml#type-hash-table">hash-table</a> with a :test function that has fewer equivalence classes  (i.e.,  does more "coalescing"), then there is no alternative now except  to use the function <a class="function-reference" href="../chapter-5.xhtml#function-equalp">EQUALP</a>. <br/>It would also be possible to extend hash tables to allow <a class="function-reference" href="../chapter-12.xhtml#function-=">=</a> or <a class="function-reference" href="../chapter-16.xhtml#function-string=">STRING=</a>, but those are not being proposed at this time. </section></div></main><footer>Copyright © 2021 Jan Moringen</footer></body></html>